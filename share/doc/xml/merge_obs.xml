<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE cxchelptopics SYSTEM "CXCHelp.dtd" [
  <!ENTITY upr  "unix&#37;">
  <!ENTITY mname "merge_obs">
  <!ENTITY rname "reproject_obs">
  <!ENTITY fname "flux_obs">

  <!ENTITY flname "_flux.img">

  <!ENTITY stackhelp "
	<PARA>
	  Use the stack syntax - see <HREF
	  link='https://cxc.harvard.edu/ciao/ahelp/stack.html'>'ahelp
	  stack'</HREF> - to specify multiple files either as a
	  comma (or space) separated list of file names or read from
	  a file using the '@' syntax.
	</PARA>
">
]>

<cxchelptopics>
  <ENTRY key="&mname;" context="tools"
	 refkeywords="merge_all merge_obsid combine add coadd coadded merge merged exposure multiple multi
		      flux fluxed
		      obs obsid obsids observation observations
		      reproject align
                      background subtract particle time subtract scale
                      BPMASK detsubsys framestore frame store shadow
		      csc soft medium hard broad wide weight weights weighted spectral spectrum"
	 seealsogroups="mergescripts"
	 displayseealsogroups="resptools">

    <SYNOPSIS>
      Reproject and combine multiple observations to
      create a merged event file and exposure-corrected images.
    </SYNOPSIS>

    <DESC>
      <PARA>
	The &mname; script takes a stack of event files and
	reprojects them to the same tangent point,
	merges them,
	creates	exposure maps for each observation, and divides the resulting
	images to produce a coadded, exposure-corrected image.
	This process can be done for one or more energy bands.
      </PARA>

      <PARA>
	For recently-processed data the script can be run with only
	two parameters: for example
      </PARA>

      <PARA>
	<SYNTAX>
	  <LINE>&upr; &mname; "*/repro/" out/</LINE>
	</SYNTAX>
      </PARA>

      <PARA>
	will store the merged data products in the directory out/,
	creating this directory if necessary.
	The output files include:
      </PARA>
      <LIST>
	<ITEM>out/merged_evt.fits, the merged events file, and</ITEM>
	<ITEM>out/broad&flname;, the exposure-corrected
	broad-band image.</ITEM>
      </LIST>

      <PARA>
	We took advantage of the
	<HREF link="https://cxc.harvard.edu/ciao/ahelp/stack.html">stack support</HREF>
	to process all the directories that match "*/repro/" -
	the quotes are needed to ensure that the shell does not do the
	matching, which would result in a parameter file error - and
	then looking for event files in these directories (see the
	description of the infile parameter for a full discussion of
	what file names are searched for).
	The examples below show other ways to use the stack support
	for specifying files.
      </PARA>

      <PARA title="How is &mname; better than merge_all?">
	The merge_all script combines the reprojected event
	files, then creates a single multi-chip exposure map for this
	file. The &mname; script creates exposure maps for each
	of the individual (reprojected) observations and then sums the resulting
	counts and exposure map images.
	The method merge_all uses does not correctly handle the case
	when observations were not taken with the same settings, such
	as differences in the SIM_X and SIM_Z values. This can lead
	to discrepencies between where the software calculates that chip edges
	and bad columns should be (when creating response functions like
	the exposure map or ARF) and where they actually are.
	The merge_all script does not use the observation-specific
	bad-pixel, mask, and DTF files, which means that
	certain instrumental effects (e.g. bad pixels, ACIS subarrays,
	cosmic-ray dead-time correction) are not included in the
	exposure map it creates. It also can not include variations in
	the response over time - e.g. when combining observations separated
	by multiple years, time dependent quantities, such as the
	amount of contamination on the ACIS optical-blocking filters,
	are not handled correctly.
      </PARA>
      <PARA>
	The extra steps taken by &mname; means it can take longer to
	run, but the script can do many of these in parallel if your
	machine has multiple processors, which can reduce this overhead.
      </PARA>

      <PARA>
	If you only wish to reproject the event files and merge them - i.e.
	you do not want the images or exposure maps - then you can
	use the &rname; script.
      </PARA>

      <PARA title="The &mname;, &rname; and &fname; scripts">
	The &mname; script combines the &rname; and &fname; script,
	so if you need more control, or wish to create exposure-corrected
	images with multiple bin sizes or grids, then it is suggested
	that you use &rname; and &fname; instead.
      </PARA>

      <PARA title="WCS alignment">
	The individual event files are reprojected to the same tangent point,
	but no attempt is made to align the observations. If you find that
	the WCS of the individual observations are not aligned - e.g. you
	can see "double" sources in the reprojected, merged data - then
	you need to update the WCS before running &mname;. An
	example is the
	<HREF link="https://cxc.harvard.edu/ciao/threads/reproject_aspect/">Correcting
	Absolute Astrometry</HREF> thread.
      </PARA>

    </DESC>

    <QEXAMPLELIST>
      <QEXAMPLE>
	<SYNTAX>
	  <LINE>&upr; download_chandra_obsid 5826,5827</LINE>
	  <LINE>&upr; chandra_repro 5826,5827 outdir=""</LINE>
	  <LINE>&upr; punlearn &mname;</LINE>
	  <LINE>&upr; &mname; 5826/,5827/ m87</LINE>
	</SYNTAX>
	<DESC>
	  <PARA>
	    The two ACIS observations in the directories
	    5826/ and 5827/ are reprojected and combined to create
	    m87_broad&flname;, which is the broad-band
	    (0.5 to 7 keV) image divided by an exposure map
	    created at 2.3 keV.
	    As these are ACIS observations the pixel size is set
	    to 8 (i.e. 3.936 arc seconds).
	  </PARA>
	  <PARA>
	    The location of the necessary support files - e.g. aspect solution,
	    bad-pixel file, mask file - are taken from
	    the headers of the event files.
	  </PARA>
	  <PARA>
	    The processing steps are run in parallel when possible to reduce the
	    run time of the script; this can be turned off by setting the parallel
	    flag to "no", or the number of processors used changed with the nproc
	    parameter.
	  </PARA>
	  <PARA title="What event files are used?">
	    When given a directory name, the script looks for files that match
	    one of the following (the first pattern to match is used):
	  </PARA>
	  <LIST>
	    <ITEM>dirname/repro/*evt*</ITEM>
	    <ITEM>dirname/primary/*evt*</ITEM>
	    <ITEM>dirname/*evt*</ITEM>
	  </LIST>
	</DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	<SYNTAX>
	  <LINE>&upr; punlearn &mname;</LINE>
	  <LINE>&upr; &mname; 5826/repro/acisf05826_repro_evt2.fits,5827/repro/acisf05827_repro_evt2.fits m87</LINE>
	</SYNTAX>
	<DESC>
	  <PARA>
	    Here we explicitly list the event files to use as a comma-separated
	    list of names.
	  </PARA>
	</DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	<SYNTAX>
	  <LINE>&upr; &mname; "*/repro/*evt2.fits" merged/</LINE>
	</SYNTAX>
	<DESC>
	  <PARA>
	    Here we use the stack support which lets CIAO tools expand out
	    patterns to list the input event files; in this case
	    all files that end in evt2.fits and are in the repro/ sub-directory
	    are used.
	  </PARA>
	  <PARA>
	    Since the outroot is set to a directory, the exposure-corrected image will
	    be called "merged/broad&flname;". The directory will be created
	    if it does not already exist.
	  </PARA>
	  <PARA>
	    If the quotes are not used around the pattern then the
	    shell will find all the matching files and send them as a space-separated
	    list to the script, which will lead to an error from the
	    CIAO parameter library.
	  </PARA>
	</DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	<SYNTAX>
	  <LINE>&upr; find . -name \*repro_evt2.fits > evt2.lis</LINE>
	  <LINE>&upr; punlearn &mname;</LINE>
	  <LINE>&upr; &mname; @evt2.lis merged/ clobber+</LINE>
	</SYNTAX>
	<DESC>
	  <PARA>
	    Here we take advantage of the stack support (see
	    <HREF link="https://cxc.harvard.edu/ciao/ahelp/stack.html">ahelp stack</HREF>)
	    to combine all the files ending in "repro_evt2.fits" that are in
	    the current directory or any of its children (this is the pattern used
	    by chandra_repro to name its output).
	  </PARA>
	</DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	<SYNTAX>
	  <LINE>&upr; &mname; "@evt2.lis[ccd_id=0:3]" merged/acisi</LINE>
	</SYNTAX>
	<DESC>
	  <PARA>
	    A DataModel filter is used to restrict the combination to only those
	    chips with a ccd_id of 0 to 3 (i.e. the ACIS-I array). This filter
	    is applied to each line of the stack file (evt2.lis).
	    Those event file which contain no data after the filter will
	    be ignored by the script.
	  </PARA>
	  <PARA>
	    The outroot has been changed so that the files do not clash with those
	    from the previous run. If you wish to overwrite them then you would
	    set outroot to merged/ and add clobber=yes to the command line call.
	  </PARA>
	</DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	<SYNTAX>
	  <LINE>&upr; &mname; @evt2.lis merged/ bands=csc</LINE>
	</SYNTAX>
	<DESC>
	  <PARA>
	    The csc band is a short form for the soft, medium, and hard
	    bands defined by the Chandra Source Catalog. This means that
	    three exposure-corrected images will be created:
	    merged/soft&flname;,
	    merged/medium&flname;,
	    and merged/hard&flname;.
	  </PARA>
	</DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	<SYNTAX>
	  <LINE>&upr; &mname; @evt2.lis merged/ psfecf=0.9</LINE>
	</SYNTAX>
	<DESC>
	  <PARA>
            Create per-observation PSF maps using an encircled-energy fraction
            of 0.9 (that is, the pixels in the PSF map give the radius,
            in arcsec, of the PSF size that contains 90 per cent of the
            PSF at that location). These maps are combined to create
            a single version for the field, using the default
            psfmerge setting, which uses the minimum ECF value at each
            pixel.
          </PARA>
          <PARA>
            The combined PSF map is called merged/broad_thresh.psfmap.
          </PARA>
        </DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	<SYNTAX>
	  <LINE>&upr; &mname; @evt2.lis merged/ psfecf=0.9 psfmerge=exptime</LINE>
	</SYNTAX>
	<DESC>
	  <PARA>
            The combined PSF map is created by weighting the ECF values
            by the observation exposure times rather than taking the
            minimum value (which is the default psfmerge setting).
          </PARA>
        </DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	<SYNTAX>
	  <LINE>&upr; &mname; @evt2.lis hires bin=2</LINE>
	</SYNTAX>
	<DESC>
	  <PARA>
	    The binsize parameter has been changed from its default value
	    of 8 to 2. This may lead to large images if there is not
	    significant overlap of all the observations.
	  </PARA>
	</DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	<SYNTAX>
	  <LINE>&upr; &mname; @evt2.lis hires maxsize=2048</LINE>
	</SYNTAX>
	<DESC>
	  <PARA>
	    In this example we force the longest dimension of the output
	    images to have 2048 pixels.
	  </PARA>
	</DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	<SYNTAX>
	  <LINE>&upr; &mname; @hrc.lis merged/</LINE>
	</SYNTAX>
	<DESC>
	  <PARA>
	    In this example a set of HRC-I observations are being
	    merged, which means that the wide band is used by default.
	    The exposure-corrected image will be called
	    merged/wide&flname;.
	  </PARA>
	  <PARA>
	    The default setting for the background parameter is "default",
	    which means that an estimate of the HRC-I particle background will
	    be subtracted from each observation
            if the HRC CALDB package
	    is installed and a match is found (as determined by the
	    <HREF link="https://cxc.harvard.edu/ciao/ahelp/hrc_bkgrnd_lookup.html">hrc_bkgrnd_lookup script</HREF>).
	    Observations for which no matching background file can
	    be found will be skipped; to include these observations
	    set background=none.
	  </PARA>
	</DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	<SYNTAX>
	  <LINE>&upr; &mname; @hrc.lis merged/ background=none</LINE>
	</SYNTAX>
	<DESC>
	  <PARA>
	    In this case the HRC-I data is processed without any background
	    subtraction (which will be significantly quicker). Please see the
	    caveat about <HREF link="https://cxc.harvard.edu/ciao/threads/expmap_hrci/index.html#caveat">"rings" seen in exposure-corrected HRC-I data</HREF>
	    for more information on why the particle background is removed by
	    default.
	  </PARA>
	</DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	<SYNTAX>
	  <LINE>&upr; &mname; @hrc.lis merged/ bands=30:200:1.1 binsize=16</LINE>
	</SYNTAX>
	<DESC>
	  <PARA>
	    In this case the images will be filtered to only include
	    events with PI=30:200, the exposure map is evaluated at 1.1 keV,
	    and a bin size of 16 (rather than the default 32)
	    is used. The final output file will be called
	    merged/30-200_flux.img.
	  </PARA>
	</DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	<SYNTAX>
	  <LINE>&upr; punlearn &mname;</LINE>
	  <LINE>&upr; pset &mname; xygrid=2000.5:6000.5:8,2048.5:6128.5:8</LINE>
	  <LINE>&upr; &mname; @evt2.lis hires</LINE>
	</SYNTAX>
	<DESC>
	  <PARA>
	    Here we give the explicit grid for the output image (a 500 by 510
	    pixel image with a bin size of 8). All observations are reprojected,
	    but only those that cover the grid will be used to create the combined
	    image.
	  </PARA>
	</DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	<SYNTAX>
	  <LINE>&upr; &mname; @evt2.lis hires xygrid=merged.img</LINE>
	</SYNTAX>
	<DESC>
	  <PARA>
	    The grid for the images is taken to match that used to create the
	    image merged.img (i.e. it is the output of
	    <HREF link="https://cxc.harvard.edu/ahelp/get_sky_limits.html">get_sky_limits</HREF>
	    when run on merged.img).
	  </PARA>
	</DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	<SYNTAX>
	  <LINE>&upr; &mname; @evt2.lis combined/ bands=broad,wgt.dat refcoord="123.45 -12.47"</LINE>
	</SYNTAX>
	<DESC>
	  <PARA>
	    The reprojection is done so that the center - i.e. (4096.5,4096.5) for
	    ACIS data - is positioned at a Right Ascension of 123.45 degrees
	    and Declination of -12.23 degrees.
	    Note that there is no check that this location is close to any
	    of the observations.
	  </PARA>
	  <PARA>
	    The position can also be given in sexagesimal notation using colon-separated
	    values - e.g.
	    <EQUATION>refcoord="8:13:48 -12:28:12"</EQUATION>
	  </PARA>
	  <PARA>
	    Two energy ranges are used: the broad band and the range defined in the
	    spectral weights file "wgt.dat" (the output for this is labelled band1).
	    The weights file.dat can be created manually or
	    with the <HREF link="https://cxc.harvard.edu/ciao/ahelp/make_instmap_weights.html">make_instmap_weights</HREF>
	    script.
	  </PARA>
	</DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	<SYNTAX>
	  <LINE>&upr; &mname; @evt2.lis combined2/ refcoord=combined/merged_evt.fits</LINE>
	</SYNTAX>
	<DESC>
	  <PARA>
	    Here we reproject the data using the same reference location
	    as the file combined/merged_evt.files (e.g. created by a
	    previous run of &mname;).
	  </PARA>
        </DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	<SYNTAX>
	  <LINE>&upr; &mname; @evt2.lis combined/ bands=plwgt.dat,bbwgt.dat nproc=-1</LINE>
	</SYNTAX>
	<DESC>
	  <PARA>
	    There will be two exposure-corrected images created in combined/, both using
	    spectral weights files:
	    band1&flname; for plwgt.dat and
	    band2&flname; for bbwgt.dat.
	  </PARA>
	  <PARA>
	    The default parameter settings for parallel (yes) and nproc (INDEF)
	    mean that all processors on your machine are used. In this example
	    we change nproc to -1, which means that it uses all-but-one of your
	    processors; so on a four-core machine the script will use three cores.
	  </PARA>
	</DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	<SYNTAX>
	  <LINE>&upr; punlearn &mname;</LINE>
	  <LINE>&upr; pset &mname; asolfiles=obs1.asol,obs2a.asol,obs2b.asol</LINE>
	  <LINE>&upr; pset &mname; badpixfiles=obs1.bpix,obs2.bpix</LINE>
	  <LINE>&upr; pset &mname; maskfiles=NONE</LINE>
	  <LINE>&upr; &mname; obs1.evt2,obs2.evt2 out/ bands=0.5:4:2</LINE>
	</SYNTAX>
	<DESC>
	  <PARA>
	    Here the two event files to be combined are called obs1.evt2 and obs2.evt2
	    and the ancillary files - aspect solution and badpixel files - are
	    explicitly given. No mask files will be used since maskfiles is set to NONE.
	    In this example the second observation has two asol files - here called obs2a.asol
	    and obs2b.asol.
	  </PARA>
	  <PARA>
	    Rather than use one of the pre-canned energy bands we use the 0.5 to 4 keV band
	    with the exposure map evaluated as 2 keV.
	  </PARA>
	  <PARA title="Stack files">
	    We could have also used stack files - e.g.
	  </PARA>
	  <PARA>
	    <SYNTAX>
	      <LINE>&upr; ls -1 *asol > asol.lis</LINE>
	      <LINE>&upr; ls -1 *bpix > bpix.lis</LINE>
	      <LINE>&upr; ls -1 *evt2 > evt2.lis</LINE>
	      <LINE>&upr; &mname; @evt2.lis out/ bands=0.5:4:2 asol=@asol.lis badpix=@bpix.lis mask=NONE</LINE>
	    </SYNTAX>
	  </PARA>
	</DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	<SYNTAX>
	  <LINE>&upr; &mname; @evt2.lis merged/ units=time</LINE>
	</SYNTAX>
	<DESC>
	  <PARA>
	    Here the exposure maps have units of seconds, rather than cm^2 s count / photon,
	    and so the exposure-corrected images have units of count / s. The energy value of the
	    band parameter - in this case 2.3 keV - is ignored and only the low and high energy
	    limits are used.
	  </PARA>
	</DESC>
      </QEXAMPLE>

    </QEXAMPLELIST>

    <PARAMLIST>
      <PARAM name="infiles" type="file" reqd="yes" stacks="yes">
	<SYNOPSIS>
	  Input event files
	</SYNOPSIS>

	<DESC>
	  <PARA>
	    Multiple event files are
            provided as a comma-separated list or as a stack; see <HREF
            link="https://cxc.harvard.edu/ciao/ahelp/stack.html">"ahelp
            stack"</HREF> for more information.
	    The observations do not need to be given in time order.
	  </PARA>

	  <PARA title="Listing just a directory name">
	    Rather than list the full path to an event file, you can
	    just give a directory name; in such a case the script
	    searches for any files that match the pattern
	  </PARA>

	  <LIST>
	    <ITEM>dirname/repro/*evt*</ITEM>
	    <ITEM>dirname/primary/*evt*</ITEM>
	    <ITEM>dirname/*evt*</ITEM>
	  </LIST>

	  <PARA>
	    where the search is done in the order given above, and stops
	    as soon as a match (or matches) is found.
	  </PARA>

	  <PARA title="Skipping files">
	    Any observations that do not match the instrument of the
	    first observation are skipped, as are CC mode observations
	    or those with no data (e.g. because of a ccd_id filter).
	    For HRC data, the first observation determines whether
	    HRC-I or HRC-S are being combined, with observations from
	    the other instrument being skipped.
	    Any file with an OBS_ID keyword of "Merged" is skipped.
	  </PARA>

	  <PARA>
	    If multiple files with the same OBS_ID keyword are found,
	    then all but the first are skipped, unless they are
	    part of an ACIS
	    <HREF link="https://cxc.harvard.edu/ciao/dictionary/altexp.html">interleaved-mode
	      observation</HREF>
	    (i.e. they have CYCLE=P or CYCLE=S).
	  </PARA>

	  <PARA>
	    The input files must contain at least the following columns,
	    otherwise they are skipped:
	  </PARA>

	  <TABLE>
	    <ROW>
	      <DATA>Instrument</DATA>
	      <DATA>Columns</DATA>
	    </ROW>
	    <ROW>
	      <DATA>ACIS</DATA>
	      <DATA>TIME, CCD_ID, ENERGY, CHIP, DET, SKY</DATA>
	    </ROW>
	    <ROW>
	      <DATA>HRC</DATA>
	      <DATA>TIME, CHIP_ID, CHIP, DET, SKY</DATA>
	    </ROW>
	  </TABLE>

	  <PARA title="File headers">
	    The header of the event file(s) is used to determine the
	    names of the supporting data files - aspect solution, bad
	    pixel, parameter block, mask, and dead-time factor files -
	    if they are not explicitly set in the parameter file.
	  </PARA>

	</DESC>
      </PARAM>

      <PARAM name="outroot" type="string" reqd="yes">
	<SYNOPSIS>
	  Root of output files
	</SYNOPSIS>

	<DESC>
	  <PARA>
	    If the
	    parameter ends in "/" then the output files are placed
	    in this directory (which will be created if necessary),
	    otherwise it is prepended to the file names, with a "_" added.
	    So, with bands=broad and outroot=fi/ the exposure-corrected image is
	    called fi/broad&flname; whereas with outroot=fi the file
	    is fi_broad&flname;.
	  </PARA>
	  <PARA>
	    An empty outroot value, or one set to ".", will cause the
	    output files to be written to the current working directory
	    with no prefix.
	  </PARA>
	</DESC>
      </PARAM>

      <PARAM name="bands" type="string" def="default">
	<SYNOPSIS>
	  What energy or PI band, or bands, should be used?
	</SYNOPSIS>

	<DESC>
	  <PARA>
	    The script will create an exposure-corrected image
	    for each band.
	    A band can be given using a name (which will
	    use the appropriate definitions from the Chandra Source
	    Catalog), by explicit limits, or by giving
	    the name of a file containing the spectral weights
	    (see <HREF link="https://cxc.harvard.edu/ciao/ahelp/make_instmap_weights.html">ahelp
	    make_instmap_weights</HREF>).
	  </PARA>
	  <PARA>
	    For the first two options,
	    the names for the output files are created using the
	    minimum and maximum limits for each band.
	    When using a weights file, the output files are
	    labelled using "band1" to "bandn", where n is the number
	    of weights file given to the parameter.
	  </PARA>

          <PARA>
            Note that the bands parameter is not used to filter the
            merged event file, it is only used to create the images
            and exposure maps.
	  </PARA>

	  <PARA title="The default setting">
	    The value of 'default' is converted to 'broad' for
	    ACIS data and 'wide' for HRC data.
	  </PARA>

	  <PARA title="Band names">
	    The following names - based on the definitions from the
	    <HREF link="https://cxc.harvard.edu/csc/columns/ebands.html">Chandra Source Catalog</HREF>
	    - can be used; energies are given in keV and the effective
	    energy is the monochromatic energy used to calculate the exposure map for the band:
	  </PARA>
	  <TABLE>
	    <ROW>
	      <DATA>Band name</DATA><DATA>Minimum Energy</DATA><DATA>Maximum Energy</DATA><DATA>Effective Energy</DATA>
	    </ROW>
	    <ROW>
	      <DATA>broad</DATA><DATA>0.5</DATA><DATA>7.0</DATA><DATA>2.3</DATA>
	    </ROW>
	    <ROW>
	      <DATA>soft</DATA><DATA>0.5</DATA><DATA>1.2</DATA><DATA>0.92</DATA>
	    </ROW>
	    <ROW>
	      <DATA>medium</DATA><DATA>1.2</DATA><DATA>2.0</DATA><DATA>1.56</DATA>
	    </ROW>
	    <ROW>
	      <DATA>hard</DATA><DATA>2.0</DATA><DATA>7.0</DATA><DATA>3.8</DATA>
	    </ROW>
	    <ROW>
	      <DATA>ultrasoft</DATA><DATA>0.2</DATA><DATA>0.5</DATA><DATA>0.4</DATA>
	    </ROW>
	    <ROW>
	      <DATA>wide</DATA><DATA>n/a</DATA><DATA>n/a</DATA><DATA>1.5</DATA>
	    </ROW>
	  </TABLE>

	  <PARA title="CSC">
	    The value "csc" can be used as a short form for the
	    combination of "soft,medium,hard".
	  </PARA>

	  <PARA title="Explicit ranges">
	    If you want to use different values to those of the CSC then
	    you can use the format lo:hi:eff where
	  </PARA>

	  <TABLE>
	    <ROW><DATA>Value</DATA><DATA>Description</DATA></ROW>
	    <ROW>
	      <DATA>lo</DATA>
	      <DATA>
		The minimum value to use: for ACIS this value is in
		keV and must be given, for HRC it is in PI channels
		and can be left blank.
	      </DATA>
	    </ROW>
	    <ROW>
	      <DATA>hi</DATA>
	      <DATA>
		The maximum value to use: for ACIS this value is in
		keV and must be given, for HRC it is in PI channels
		and can be left blank.
	      </DATA>
	    </ROW>
	    <ROW>
	      <DATA>eff</DATA>
	      <DATA>
		The effective energy for the instrument map and exposure
		map, in keV. This is required for both ACIS and HRC
		observations.
	      </DATA>
	    </ROW>
	  </TABLE>

	  <PARA title="Spectral weights">
	    If a filename is given then it is assumed to be an ASCII
	    file containing spectral weights; two colums giving the
	    energy in keV and the weight value for that energy.
	    This file can be created using the make_instmap_weights script,
	    the save_instmap_weights() routine from the
	    sherpa_contrib.utils module, or manually; see the description
	    of the
	    <HREF link="https://cxc.harvard.edu/ciao/ahelp/mkinstmap.html#plist.spectrumfile">spectrumfile
	    parameter of mkinstmap</HREF>
	    for more information on the format of this file.
	  </PARA>

	  <PARA>
	    The energy limits to use for the images are calculated from
	    this file. If the file contains two lines (before the data)
	    with the format
	  </PARA>
	  <PARA>
	    <SYNTAX>
	      <LINE># ENERG_LO = elo</LINE>
	      <LINE># ENERG_HI = ehi</LINE>
	    </SYNTAX>
	  </PARA>
	  <PARA>
	    then the elo and ehi values are taken for the limits (they
	    are assumed to be in keV). This format is created by
	    the make_instmap_weights script and the save_instmap_weights()
	    routine.
	    If these lines do not exist, or the elo/ehi values are not
	    valid numbers, then the limits will be calculated from
	    the first column using the formulae (x1 is the
	    first value, xn is the last, and xm the last-but-one value):
	    <EQUATION>elo = (3 * x1 - x2) / 2</EQUATION>
	    <EQUATION>ehi = (3 * xn - xm) / 2</EQUATION>
	  </PARA>

	  <PARA title="Multiple bands">
	    Multiple bands can be given either by using the name "csc"
	    or by using a comma-separated list. The different schemes
	    can be combined, so the following are all valid
	    (where wgt1.dat and wgt2.dat are weights files):
	  </PARA>
	  <PARA>
	    <SYNTAX>
	      <LINE>bands="csc,broad"</LINE>
	      <LINE>bands="0.5:7:2.5,ultrasoft"</LINE>
	      <LINE>bands="0.5:7:2.5,csc,wgt1.dat,wgt2.dat"</LINE>
	    </SYNTAX>
	  </PARA>
	  <PARA>
	    At present multiple bands can not be used with HRC data.
	  </PARA>
	</DESC>
      </PARAM>

      <PARAM name="xygrid" type="string" def="">
	<SYNOPSIS>
	  xygrid for output or filename
	</SYNOPSIS>
	<DESC>
	  <PARA>
	    When set, this parameter overrides both the
	    maxsize and bin parameters, and defines
	    the SKY coordinate range and binning used
	    to create the output count images, exposure
	    maps, and exposure-corrected images.
	  </PARA>

	  <PARA title="xygrid is set">
	    When set, it can either be:
	  </PARA>
	  <LIST>
	    <ITEM>a filename,</ITEM>
	    <ITEM>a grid specification of the form
	    "xlo:xhi:#nx or dx,ylo:yhi:#ny or dy".</ITEM>
	  </LIST>
	  <PARA>
	    If a filename is given then its sky
	    range is used to determine the output;
	    this is useful if you want to create an exposure-corrected
	    image that matches an existing image.
	    Otherwise the grid range is given explicitly;
	    examples include "3824.5:5112.5:#161,4008.5:5296.5:#161"
	    and "3824.5:5112.5:8,4008.5:5296.5:8".
	  </PARA>

	  <PARA title="xygrid is not set">
	    When left at the default (empty) value, the
	    script calculates the xygrid for the output
	    image based on the observational data; the
	    skyfov tool is used to determine the maximum
	    area of the sky that is covered by the
	    observations. In this mode the bin size is
	    determined by either the maxsize or
	    binsize parameters.
	  </PARA>
	</DESC>
      </PARAM>

      <PARAM name="maxsize" type="real" def="INDEF" min="1">
	<SYNOPSIS>
	  Maximum image width or height in pixels
	</SYNOPSIS>
	<DESC>
	  <PARA>
	    This parameter is only used if the xygrid is empty (set
	    to "").
	  </PARA>
	  <PARA>
	    If set (i.e. changed from INDEF) then the maximum dimension of the
	    output image is set to this value.
	    This can be useful if you quickly want to look at data
	    and want to make sure the output image is not too large.
	    Note that due to the way the ranges are calculated the
	    actual image dimension is only guaranteed to be within
	    a few pixels of the requested value.
	  </PARA>
	  <PARA>
	    The SKY ranges for the images are determined automatically,
	    based on the ranges of the FOV files for each observation
	    (see "ahelp skyfov").
	  </PARA>
	</DESC>
      </PARAM>

      <PARAM name="binsize" type="real" def="INDEF" min="0">
	<SYNOPSIS>
	  Image binning factor
	</SYNOPSIS>
	<DESC>
	  <PARA>
	    This parameter is only used if the xygrid is empty (set
	    to "") and maxsize is set to INDEF.
	  </PARA>
	  <PARA>
	    When set to INDEF a default value is used:
	    8 for ACIS data and 32 for HRC data.
	    The binning factor has units of the
	    SKY pixel (0.492" for ACIS and 0.1318" for HRC),
	    so binsize=4 for an ACIS observation will create
	    images with 1.968 arcsecond pixels.
	    The value need not be an integer, and can be less
	    than 1 if you want to look at small-scale structure near
	    the aim point of the observation; in this case it is strongly
	    suggested that a spatial filter is applied to ensure
	    manageable file sizes.
	  </PARA>
	  <PARA>
	    The SKY ranges for the images are determined automatically,
	    based on the ranges of the FOV files for each observation
	    (see "ahelp skyfov").
	  </PARA>
	</DESC>
      </PARAM>

      <PARAM name="asolfiles" type="file" stacks="yes">
	<SYNOPSIS>
	  Input aspect solutions
	</SYNOPSIS>

	<DESC>
	  <PARA>
	    If the value is empty then the ASOLFILE keyword from
	    the events files will be used to find the
	    files to use.
	    Unlike the other ancillary products, an aspect
	    solution is required for the script to run.
	  </PARA>
	  <PARA>
	    The aspect solution files have names like
	    pcadf*_asol1.fits and are included in the
	    output directory of the chandra_repro script.
	    To explicitly specify the asol files use
	    the stack syntax (e.g. a comma, or space, separated
	    string or an external file as described in
	    <HREF
		link="https://cxc.harvard.edu/ciao/ahelp/stack.html">"ahelp
	    stack"</HREF> for more information).
	    So to use asol1.fits, asol2.fits, and asol3.fits you could say
	    <EQUATION>asolfile="asol1.fits,asol2.fits,asol3.fits"</EQUATION>
	    or
	    <EQUATION>asolfile="asol1.fits asol2.fits asol3.fits"</EQUATION>
	    or
	    <EQUATION>asolfile=@asol.lis</EQUATION>
	    where asol.lis contains the names of each file, one per line.
	    The files do not have to be given in time order.
	  </PARA>
	  <PARA>
	    Since there may be multiple asol files for an
	    observation there may be more entries in this
	    parameter than there are in the infiles parameter.
	  </PARA>
	  <PARA>
	    Aspect histograms - the output of the asphist tool - can
	    not be used here.
	  </PARA>
	</DESC>
      </PARAM>

      <PARAM name="badpixfiles" type="file" stacks="yes">
	<SYNOPSIS>
	  Input bad pixel files
	</SYNOPSIS>

	<DESC>
	  <PARA>
	    If the value is empty then the BPIXFILE keyword from
	    the events files will be used to find the
	    files to use.
	  </PARA>
	  <PARA>
	    A value of "CALDB" will use the CalDB bad-pixel
	    file and "NONE" will use no bad-pixel file
	    (the value is case insensitive).
	    The bad-pixel file is not required to run the
	    script, but care should be taken when analyzing the
	    output if it is not used.
	  </PARA>
	  <PARA>
	    The bad-pixel file has a name like
	    acisf*bpix1.fits and is included in the
	    output directory of the chandra_repro script.
	    If you have used or created a custom bad-pixel file
	    for the observations then these should
	    be used.
	  </PARA>
	  &stackhelp;
	  <PARA>
	    The order of the bad-pixel
	    files does not need to match that of the infiles parameter.
	  </PARA>
	</DESC>
      </PARAM>

      <PARAM name="maskfiles" type="file" stacks="yes">
	<SYNOPSIS>
	  Input mask files
	</SYNOPSIS>

	<DESC>
	  <PARA>
	    If the
	    parameter is empty then the
	    MASKFILE keyword in the events files will be used.
	    A value of "NONE" will use no mask file in the
	    analysis; in this case care should be taken when
	    analyzing the results since the exposure map
	    will not be correct if the data was taken
	    using a sub array (i.e. not all the chips or ccds
	    were read out).
	  </PARA>
	  <PARA>
	    The mask file has a name like
	    acisf*msk1.fits and is included in the
	    output directory of the chandra_repro script.
	  </PARA>
	  &stackhelp;
	  <PARA>
	    The order of the mask
	    files does not need to match that of the infiles parameter.
	  </PARA>
	</DESC>
      </PARAM>

      <PARAM name="dtffiles" type="file" stacks="yes">
	<SYNOPSIS>
	  Input dtf files for HRC observations
	</SYNOPSIS>

	<DESC>
	  <PARA>This parameter is only used with HRC observations.</PARA>
	  <PARA>
	    If the
	    parameter is empty then the
	    DTFFILE keyword in the events files will be used.
	    A value of "NONE" will mean that only a mean
	    DTF value will be used.
	  </PARA>
	  <PARA>
	    The file has a name like
	    hrcf*dtf1.fits and is included in the
	    output directory of the chandra_repro script.
	  </PARA>
	  &stackhelp;
	  <PARA>
	    The order of the dtf
	    files does not need to match that of the infiles parameter.
	  </PARA>
	</DESC>
      </PARAM>

      <PARAM name="refcoord" type="string" def="">
	<SYNOPSIS>Reference coordinates or evt2 file</SYNOPSIS>
	<DESC>
	  <PARA>
	    This parameter defines the central coordinate of the
	    reprojected data; that is the Right Ascension and Declination
	    that maps to
	    SKY=(4096.5,4096.5) for ACIS data,
	    (16384.5,16384.5) for HRC-I data, or
	    (32768.5,32768.5) for HRC-S data.
	  </PARA>
	  <PARA>
	    The default setting ("") means that this value is calculated
	    from the tangent points of the observations. When set it
	    can be either:
	  </PARA>
	  <LIST>
	    <ITEM>
	      the name of a file, so that the tangent position of the file
	      is used;
	    </ITEM>
	    <ITEM>
	      or a space-separated value taken to be the RA and Declination
	      to use (ICRS) in decimal degrees or
	      colon-separated sexagesimal formats.
	    </ITEM>
	  </LIST>
	  <PARA>
	    Examples include:
	  </PARA>
	  <PARA>
	    <SYNTAX>
	      <LINE>refcoord=fluxed/broad_flux.img</LINE>
	      <LINE>refcoord="123.45 -12.34"</LINE>
	      <LINE>refcoord="8:13:48 -12:20:24"</LINE>
	    </SYNTAX>
	  </PARA>
	</DESC>
      </PARAM>

      <PARAM name="units" type="string" def="default">
	<SYNOPSIS>
	  Units for the exposure map
	</SYNOPSIS>

	<DESC>
	  <PARA>
	    This parameter determines the units of the instrument
	    and exposure maps.
	  </PARA>
	  <TABLE>
	    <ROW>
	      <DATA>units</DATA><DATA>Exposure map</DATA><DATA>Exposure-corrected image</DATA>
	    </ROW>
	    <ROW>
	      <DATA>default</DATA><DATA>cm^2 s count / photon</DATA><DATA>photon / cm^2 / s</DATA>
	    </ROW>
	    <ROW>
	      <DATA>area</DATA><DATA>cm^2 count / photon</DATA><DATA>photon / cm^2</DATA>
	    </ROW>
	    <ROW>
	      <DATA>time</DATA><DATA>s</DATA><DATA>count / s</DATA>
	    </ROW>
	  </TABLE>
	  <PARA>
	    This parameter combines the normalize parameter of
	    mkexpmap and the modifiers for the detsubsys and mirror
	    parameters of mkinstmap (see 'ahelp ardlib').
	  </PARA>
	  <PARA title="What is units=time equivalent to?">
	    When units=time is used, instrument maps are created with
	    the additional settings:
	  </PARA>
	  <LIST>
	    <ITEM>
	      ";IDEAL" is appended to the
	      detsubsys parameter to remove any correction for the
	      detector quantum efficiency (QE), quantum efficiency
	      uniformities (QEU),
	      or the ACIS contamination model;
	    </ITEM>
	    <ITEM>
	      the mirror parameter is set to "HRMA;area=1" rather than
	      "HRMA" to ignore the effective area of the Chandra mirrors;
	    </ITEM>
	    <ITEM>
	      and the dafile parameter is set to "NONE" to
	      remove the ACIS "dead area" correction, which accounts for
	      the (small) decrease in detector efficiency due to the
	      background cosmic ray flux.
	    </ITEM>
	  </LIST>
	  <PARA>
	    The result is that the instrument map pixels have values of
	    0 or 1.
	  </PARA>
	</DESC>
      </PARAM>

      <PARAM name="expmapthresh" type="string" def="1.5%">
	<SYNOPSIS>
	  Remove low-exposure regions?
	</SYNOPSIS>

	<DESC>
	  <PARA>
	    If set to "" then no clipping of the counts images
	    or exposure maps
	    is performed before creating the exposure-corrected
	    image.
	  </PARA>
	  <PARA>
	    When set, the parameter determines how the
	    per-observation counts image and exposure maps
	    are clipped before being combined together to
	    create the exposure-corrected image.
	    This can be used to  exclude those
	    pixels at the edge of a chip which, due to the
	    strong gradient in the exposure map, end up
	    dominating the final image.
	  </PARA>
	  <PARA>
	    For a full list of supported options, see the
	    description of the cut parameter of dmimgthresh.
	    Here we discuss the two most common options:
	  </PARA>
	  <LIST>
	    <ITEM>
	      expmapthresh="2%", which excludes those pixels where the
	      exposure map falls below 2% of its peak value,
	    </ITEM>
	    <ITEM>
	      and expmapthresh="100", which excludes those pixels where
	      the exposure map value is less than 100 (in this case the
	      value of the units parameter is important).
	    </ITEM>
	  </LIST>
	  <PARA>
	    Note that both the counts image and the exposure map for
	    each observation are thresholded before being combined
	    together rather than the thresholding being applied to
	    the final, coadded, image and exposure map.
	  </PARA>
	</DESC>
      </PARAM>

      <PARAM name="background" type="string" def="default">
	<SYNOPSIS>
	  Method for background removal (HRC-I)
	</SYNOPSIS>

	<DESC>
	  <PARA>
	    This parameter is only used for HRC-I data.
	    The reason for subtracting the particle background
	    component is to help
	    remove the
	    <HREF link="https://cxc.harvard.edu/ciao/threads/expmap_hrci/index.html#caveat">"rings" seen in exposure-corrected HRC-I data</HREF>,
	    but does significantly increase the time
	    taken to run the script.
	  </PARA>
	  <PARA>
	    If set to "none", or no HRC-I background CALDB
	    files can not be found, then the data is processed with
	    no background subtraction.
	    Observations for which a HRC-I background file can not
	    be found - when background is not set to "none" - will
	    be removed from the analysis.
	  </PARA>
	  <PARA title="method=default">
	    This is the same as method=time.
	  </PARA>
	  <PARA title="method=time">
	    This setting scales the background file by the
	    ratio of the observation to background exposure
	    times. It is the method used in the thread
	    discussed above.
	  </PARA>
	  <PARA title="method=particle">
	    This option scales
	    the background by the ratio of the counts
	    in the range determined by the bkgparams
	    parameter, rather than by exposure
	    time.
	  </PARA>
          <PARA title="Header keywords">
            The full path to the selected background event file is
            added to the header file of the background-subtracted image
            and fluxed image using the BEVTFILE keyword.
	    The scaling method and factor are added to the relevant files
	    using the BKGMETH and BKGSCALE keywords, respectively.
	  </PARA>
	</DESC>
      </PARAM>

      <PARAM name="bkgparams" type="string" def="[pi=300:500]">
	<SYNOPSIS>
	  Optional argument for background subtraction
	</SYNOPSIS>
	<DESC>
	  <PARA>
	    This is only used when background subtraction occurs
	    and the method being used is set to "particle".
	    The parameter is taken to be
	    <HREF link="https://cxc.harvard.edu/ciao/ahelp/dmfiltering.html">a
	    Data Model filter</HREF>
	    to apply to both the observation and the
	    particle background file, and is expected to
	    be of the form "[pi=lo:hi]". It is used to select
	    a subset of the observation that represents
	    the particle background - i.e. it is
	    not strongly
	    "contaminated" by cosmic emission - but
	    is close enough (in PI) to the source emission
	    to minimise differences in the spectral shape of
	    the particle emission between the observation and
	    that seen in the background observations.
	  </PARA>
	</DESC>
      </PARAM>

      <PARAM name="psfecf" type="real" def="INDEF" min="0" max="1">
	<SYNOPSIS>
          If set, create PSF map with this ECF
	</SYNOPSIS>
	<DESC>
	  <PARA>
            If set, create a "PSF map" image, which contains the radius
            of the PSF which contains this ECF for each pixel, in
            arcseconds. The calculation is done by the mkpsfmap
            tool, and the energy is taken to be the same value used
            to create the exposure maps (the effective energy described
            in the the bands parameter or the weight file).
          </PARA>
          <PARA>
            The output files are identified by the label "psfmap".
            The combined version is controlled by the psfmerge
            parameter.
          </PARA>
          <PARA title="Note">
            The PSF sizes are calculated using a number of approximations
            and so should not be used for detailed analysis of sources,
            where the PSF should be modelled as discussed in the
            <HREF link="https://cxc.harvard.edu/ciao/PSFs/psf_central.html">CIAO
            PSF Central documentation</HREF>.
          </PARA>
        </DESC>
      </PARAM>

      <PARAM name="psfmerge" type="string" def="min">
	<SYNOPSIS>
          How are the PSF maps combined?
	</SYNOPSIS>
	<DESC>
	  <PARA>
            There is no one "correct" way to combine the per-observation
            PSF maps, so this script provides several options, which
            are controlled by the psfmerge parameter.
            The output file is identified by the label "psfmap".
          </PARA>
          <PARA>
            The available options for psfmerge are:
            exptime, expmap, min, max, mean, median, and mid.
          </PARA>
          <PARA title="psfmerge=exptime">
            Weight each pixel by the exposure time of the observation,
            dividing by the total exposure time observed by the pixel.
          </PARA>
          <PARA title="psfmerge=expmap">
            Weight each pixel by the exposure map of the observation,
            dividing by the sum of the exposure map values for the pixel.
            This result should be similar to using the "exptime" method,
            but will include features seen in the exposure maps, such
            as bad pixels and columns.
          </PARA>
          <PARA title="psfmerge=min">
            Use the minimum PSF size for each pixel.
          </PARA>
          <PARA title="psfmerge=max">
            Use the maximum PSF size for each pixel.
          </PARA>
          <PARA title="psfmerge=mean">
            Use the average PSF size for each pixel.
          </PARA>
          <PARA title="psfmerge=median">
            Use the median of the PSF sizes for each pixel. If there are an
            even number (n) values to chose from, then the median is
            taken to be the n/2-th value, rather than averaging the
            (n/2) and (n/2)+1 values.
          </PARA>
          <PARA title="psfmerge=mid">
            Use the mid-point of the PSF sizes for each pixel. This finds
            the minimum (min) and maximum (max) PSF size for a pixel and uses
            (min + max) / 2.
          </PARA>
        </DESC>
      </PARAM>

      <PARAM name="random" type="integer" def="0" min="0">
        <SYNOPSIS>
          Random seed for randomization.
        </SYNOPSIS>

         <DESC>
           <PARA>
	     The random parameter is sent to reproject_events
	     when processing the HRC-I background files to
	     match the observation. A value of 0 uses the
	     system time to seed the random number generator.
           </PARA>
         </DESC>
      </PARAM>

      <PARAM name="parallel" type="boolean" def="yes">
	<SYNOPSIS>
	  Run processes in parallel?
	</SYNOPSIS>
	<DESC>
	  <PARA>
	    When run on a multi-processor system, many of the
	    tasks can be run in parallel to reduce the
	    execution time of the script.
	    Since the tasks are likely to be memory or I/O-bound,
	    the reduction in run time will be less than the
	    number of cores on a machine.
	    When parallel=yes, the default behaviour is to use all
	    the CPU processors, but this can be changed with
	    the nproc parameter.
	  </PARA>
	  <PARA>
	    This option can be ignored when run on a single-processor
	    system.
	  </PARA>
	</DESC>
      </PARAM>

      <PARAM name="nproc" type="integer" def="INDEF">
	<SYNOPSIS>
	  Number of processors to use
	</SYNOPSIS>
	<DESC>
	  <PARA>
	    This parameter is only used when parallel=yes. It determines
	    the number of processors to use. If maxproc is the actual
	    number of processors on your machine, then
	    a value of INDEF - the default value - means that all
	    maxproc processors will be used.  A positive value
	    means to use that number of processors (any value
	    larger than maxproc will be set to maxproc).
	    A negative value is added to maxproc (and any value less
	    than one is set to one).
	  </PARA>
	  <!--
	  <TABLE>
	    <CAPTION>
	      The number of processors to be used
	      for a variety of nproc and maxproc values (assuming parallel=yes).
	    </CAPTION>
	    <ROW>
	      <DATA>nproc argument</DATA>
	      <DATA>maxproc</DATA>
	      <DATA>number of processors used</DATA>
	    </ROW>
	    <ROW>
	      <DATA>INDEF</DATA>
	      <DATA>4</DATA>
	      <DATA>4</DATA>
	    </ROW>
	    <ROW>
	      <DATA>INDEF</DATA>
	      <DATA>2</DATA>
	      <DATA>2</DATA>
	    </ROW>
	    <ROW>
	      <DATA>INDEF</DATA>
	      <DATA>1</DATA>
	      <DATA>1</DATA>
	    </ROW>
	    <ROW>
	      <DATA>3</DATA>
	      <DATA>4</DATA>
	      <DATA>3</DATA>
	    </ROW>
	    <ROW>
	      <DATA>3</DATA>
	      <DATA>2</DATA>
	      <DATA>2</DATA>
	    </ROW>
	    <ROW>
	      <DATA>3</DATA>
	      <DATA>1</DATA>
	      <DATA>1</DATA>
	    </ROW>
	    <ROW>
	      <DATA>-1</DATA>
	      <DATA>4</DATA>
	      <DATA>3</DATA>
	    </ROW>
	    <ROW>
	      <DATA>-1</DATA>
	      <DATA>2</DATA>
	      <DATA>1</DATA>
	    </ROW>
	    <ROW>
	      <DATA>-1</DATA>
	      <DATA>1</DATA>
	      <DATA>1</DATA>
	    </ROW>
	    <ROW>
	      <DATA>-2</DATA>
	      <DATA>4</DATA>
	      <DATA>2</DATA>
	    </ROW>
	    <ROW>
	      <DATA>-2</DATA>
	      <DATA>2</DATA>
	      <DATA>1</DATA>
	    </ROW>
	    <ROW>
	      <DATA>-2</DATA>
	      <DATA>1</DATA>
	      <DATA>1</DATA>
	    </ROW>
	  </TABLE>
	  -->
	</DESC>
      </PARAM>

      <PARAM name="tmpdir" type="string" def="${ASCDS_WORK_PATH}">
	<SYNOPSIS>
	  Directory for temporary files.
	</SYNOPSIS>
	<DESC>
	  <PARA>
	    Directory for storing temporary files that
	    require further processing before becoming useful.
	    If the directory does not exist then it will be created
	    for use by the script, and then deleted.
	  </PARA>
	</DESC>
      </PARAM>

      <PARAM name="cleanup" type="boolean" def="yes">
	<SYNOPSIS>
	  Cleanup intermediary files on exit.
	</SYNOPSIS>

	<DESC>
	  <PARA>
	    If set to "yes", the intermediate data products
	    are deleted when the script ends, leaving only: the
	    reprojected event files; merged event file;
	    per-observation images, exposure maps, and
	    exposure-corrected images; and the combined images, exposure
	    maps, and exposure-corrected images.
	  </PARA>
	</DESC>
      </PARAM>

      <PARAM name="clobber" type="boolean" def="no">
	<SYNOPSIS>
	  Overwrite existing files?
	</SYNOPSIS>
      </PARAM>

      <PARAM name="verbose" type="integer" def="1" min="0" max="5">
	<SYNOPSIS>
	  Output verbosity.
	</SYNOPSIS>

	<DESC>
	  <PARA>
	    The default verbosity value of 1 prints status
	    messages as the script runs.  Higher verbosity
	    settings print the commands that are being run.
	    Setting verbose=0 turns off most of the screen
	    output (some output is currently unavoidable).
	  </PARA>
	</DESC>
      </PARAM>
    </PARAMLIST>

    <ADESC title="Energy bands">
      <PARA>
	The energy bands - when given by name - are taken from the
	<HREF link="https://cxc.harvard.edu/csc/columns/ebands.html">Chandra Source Catalog definitions.</HREF>
	The default bands setting (i.e. "default") means
	to use the "broad" band setting for ACIS data
	and the "wide" band setting for HRC data.
	Another common choice (for ACIS data) is "csc", which
	creates the "soft", "medium", and "hard" bands.
      </PARA>
      <PARA>
	The examples and description of the
	band parameter describe how explicit energy ranges and
	effective energies can be specified if required.
	A spectral weights file can also be used if required.
      </PARA>

      <PARA>
	Examples of specifying the bands are:
      </PARA>
      <PARA>
	<SYNTAX>
	  <LINE>&upr; &mname; "*evt2.fits" out/</LINE>
	  <LINE>&upr; &mname; "*evt2.fits" out/ bands=csc</LINE>
	  <LINE>&upr; &mname; @evt2.lis out/ bands=0.5:2:1.7</LINE>
	  <LINE>&upr; &mname; @evt2.lis out/ bands=csc,broad</LINE>
	  <LINE>&upr; &mname; @evt2.lis out/ bands=wgt.dat</LINE>
	</SYNTAX>
      </PARA>
      <PARA>
	which use
      </PARA>
      <LIST>
        <ITEM>the default band (so broad for ACIS, wide for HRC),</ITEM>
        <ITEM>the CSC setting (soft, medium, and hard bands),</ITEM>
	<ITEM>an explicit range of 0.5 to 2 keV with an exposure map
	evaluated at 1.7 keV,</ITEM>
	<ITEM>four bands (soft, medium, hard, and broad),</ITEM>
	<ITEM>and a spectral-weights file (wgt.dat), created either manually
	or with the make_instmap_weights script.</ITEM>
      </LIST>
      <PARA title="ACIS low-energy bands and the ACIS contamination">
	Please review the
	<HREF link="https://cxc.cfa.harvard.edu/ciao/why/low_energy_mono.html">Monochromatic Energy for Low Energy Bands</HREF>
	document for the latest information on how the ACIS
	contamination layer can affect the analysis when using
	a mono-chromatic energy for calculating exposure maps,
	such as setting the bands parameter to one of the CSC
	bands (in particular the soft band).
      </PARA>
    </ADESC>

    <ADESC title="Parallel processing">
      <PARA>
	The execution time can be reduced by running some steps in
	parallel. This is controlled by the parallel flag,
	which defaults to yes.
	The nproc parameter
	controls the number of processors that will be used;
	the default is to use all of then.
	If run on a single-processor machine then both
	parameters are ignored.
      </PARA>
    </ADESC>

    <ADESC title="Output files">
      <PARA>
	The primary output files are named using the following schemes:
      </PARA>

      <TABLE>
	<CAPTION>Combined data</CAPTION>
	<ROW><DATA>Type</DATA><DATA>Filename</DATA></ROW>
	<ROW><DATA>Merged event file</DATA><DATA>outroot_merged_evt.fits</DATA></ROW>
	<ROW><DATA>Counts image</DATA><DATA>outroot_blabel.img</DATA></ROW>
	<ROW><DATA>Combined exposure map</DATA><DATA>outroot_blabel.expmap</DATA></ROW>
	<ROW><DATA>Clipped counts image</DATA><DATA>outroot_blabel_thresh.img</DATA></ROW>
	<ROW><DATA>Clipped exposure map</DATA><DATA>outroot_blabel_thresh.expmap</DATA></ROW>
        <ROW>
          <DATA>PSF map (optional)</DATA>
          <DATA>outroot_blabel.psfmap or outroot_blabel_thresh.psfmap</DATA>
        </ROW>
	<ROW><DATA>Exposure-corrected image</DATA><DATA>outroot_blabel&flname;</DATA></ROW>
      </TABLE>

      <TABLE>
	<CAPTION>Per-observation data</CAPTION>
	<ROW><DATA>Type</DATA><DATA>Filename</DATA></ROW>
	<ROW><DATA>Reprojected event file</DATA><DATA>outroot_obsid_reproj_evt.fits</DATA></ROW>
	<ROW><DATA>Counts image</DATA><DATA>outroot_obsid_blabel.img</DATA></ROW>
	<ROW><DATA>Combined exposure map</DATA><DATA>outroot_obsid_blabel.expmap</DATA></ROW>
	<ROW><DATA>Clipped counts image</DATA><DATA>outroot_obsid_blabel_thresh.img</DATA></ROW>
	<ROW><DATA>Clipped exposure map</DATA><DATA>outroot_obsid_blabel_thresh.expmap</DATA></ROW>
        <ROW>
          <DATA>PSF map (optional)</DATA>
          <DATA>outroot_obsid_blabel.psfmap or outroot_obsid_blabel_thresh.psfmap</DATA>
        </ROW>
	<ROW><DATA>Exposure-corrected image</DATA><DATA>outroot_outsid_blabel_flux.img</DATA></ROW>
      </TABLE>

      <PARA>
	where blabel is either the band name (e.g. soft, broad, ...),
	"lo-hi" where lo and hi are the limits of the
	range (keV for ACIS, PI for HRC), or band1 to bandn (when using spectral
	weight files).
	The above is when outroot does not end in a "/"; if it does then
	remove "outroot_" and the files will be created in the directory
	named by outroot. Examples of the exposure-corrected image
	name for a combination of bands and outroot settings are given
	in the following table:
      </PARA>

      <TABLE>
	<CAPTION>Names of the exposure-corrected coadded images</CAPTION>
	<ROW>
	  <DATA>outroot</DATA>
	  <DATA>bands=broad</DATA>
	  <DATA>bands=0.5:2:1.5 (ACIS)</DATA>
	  <DATA>bands=30:200:1.1 (HRC)</DATA>
	  <DATA>bands=wgt.dat</DATA>
	</ROW>
	<ROW>
	  <DATA>fimg</DATA>
	  <DATA>fimg_broad&flname;</DATA>
	  <DATA>fimg_0.5-2&flname;</DATA>
	  <DATA>fimg_30-200&flname;</DATA>
	  <DATA>fimg_band1&flname;</DATA>
	</ROW>
	<ROW>
	  <DATA>odir/</DATA>
	  <DATA>odir/broad&flname;</DATA>
	  <DATA>odir/0.5-2&flname;</DATA>
	  <DATA>odir/30-200&flname;</DATA>
	  <DATA>odir/band1&flname;</DATA>
	</ROW>
	<ROW>
	  <DATA>odir/fimg</DATA>
	  <DATA>odir/fimg_broad&flname;</DATA>
	  <DATA>odir/fimg_0.5-2&flname;</DATA>
	  <DATA>odir/fimg_30-200&flname;</DATA>
	  <DATA>odir/fimg_band1&flname;</DATA>
	</ROW>
      </TABLE>

      <PARA>
	For HRC data, using bands=::eval results in a label
	of "all" being used.
      </PARA>

      <PARA title="Interleaved mode">
	For interleaved-mode data, "e1" or "e2" is appended to the ObsId
	value when creating file names.
      </PARA>

      <!--
	  <PARA>
	  The intermediary files follow the same rule for outroot and have
	  the form given below, where ccd refers to the plate number for HRC
	  data:
	  </PARA>

	  <TABLE>
	  <ROW><DATA>Type</DATA><DATA>Filename</DATA></ROW>
	  <ROW><DATA>Aspect histograms</DATA><DATA>outroot_ccd.asphist</DATA></ROW>
	  <ROW><DATA>HRC-I background image</DATA><DATA>outroot_HRC-I_bkg.fits</DATA></ROW>
	  <ROW><DATA>Instrument maps</DATA><DATA>outroot_ccd_blabel.instmap</DATA></ROW>
	  <ROW><DATA>Per chip/plate exposure maps</DATA><DATA>outroot_ccd_blabel.expmap</DATA></ROW>
	  </TABLE>

	  <PARA>
	  By default, the intermediary per-chip data products are
	  removed after the script has completed running. To save
	  these (potentially numerous) files, set the cleanup
	  parameter to 'no'.
	  </PARA>
      -->
    </ADESC>

    <ADESC title="Output image area and size">
      <PARA>
	The default behavior - when xygrid="" - is to calculate the output image
	size so that it covers all the data:
	a FOV file is created for the observation and the limits
	of this file are used to determine the X and Y range
	of the image.
	In this mode the binning is set by either the maxsize or
	binzise parameters.
	The maxsize parameter - if set - determines the maximum number of pixels
	used along the longest edge of the output,
	otherwise the binsize parameter is used. This
	parameter is in units of the native pixel size (i.e. 0.492" for
	ACIS and 0.1318" for HRC), and can be set to sub-pixel
	values (e.g. 0.5).
      </PARA>
      <PARA>
	The tool can also be given an explicit grid for the output
	image size using the xygrid parameter (in this mode the binsize
	parameter is ignored). The grid can either be:
      </PARA>
      <LIST>
	<ITEM>a filename,</ITEM>
	<ITEM>or a grid specification, of the form "xlo:xhi:#nx or dx,ylo:yhi:#ny or dy".</ITEM>
      </LIST>
      <PARA>
	When given a file, the sky range of the file is used for
	the output (e.g. the get_sky_limits tool is run on the
	file and its xygrid parameter value is used).
	Otherwise, the grid is given using the same format as the
	xygrid parameter of mkexpmap; examples include:
	<EQUATION>3824.5:5112.5:8,4008.5:5296.5:8</EQUATION>
	and
	<EQUATION>3824.5:5112.5:#161,4008.5:5296.5:#161</EQUATION>
      </PARA>

      <PARA>
	If the requested grid results in the last row or column being
	partially filled - in other words the width or height divided by the
	bin size is not a whole number - then the exposure map values in the
	column or row will be over estimated (since they are calculated assuming
	that the pixel is "full").
      </PARA>

      <PARA title="Handling filter or grids that do not overlap the observation">
	The tool will error out when there is no overlap between the observation
	and the xygrid (if given) or any spatial filter applied to the input file.
      </PARA>
    </ADESC>

    <ADESC title="Required data files">
      <PARA>
	For observations that has been reprocessed by chandra_repro, then
	all that is needed is to give the events file since the
	required ancillary files can be found using the
	header of the events file (the chandra_repro script ensures
	that all the files needed for this script are copied to the same
	directory as the events file).
	These ancillary files can be located in one of the following
	directories, relative to the events file:
      </PARA>

      <LIST>
	<ITEM>.</ITEM>
	<ITEM>repro/</ITEM>
	<ITEM>primary/</ITEM>
	<ITEM>secondary/</ITEM>
	<ITEM>../repro/</ITEM>
	<ITEM>../primary/</ITEM>
	<ITEM>../secondary/</ITEM>
      </LIST>

      <PARA>
	If the files are not in one of these directories, they
	have been renamed, or new versions have been created during
	your analysis (e.g. a new bad-pixel file or a reprojected
        aspect solution created
        by reproject_aspect) then
	they can be explicitly set using the following parameters:
      </PARA>

      <TABLE>
	<CAPTION>Ancillary data products</CAPTION>
	<ROW>
	  <DATA>Parameter name</DATA><DATA>Description</DATA>
	</ROW>
	<ROW>
	  <DATA>asolfile</DATA>
	  <DATA>
	    The aspect solution for the observation, which may be
	    split over multiple files.
	  </DATA>
	</ROW>
	<ROW>
	  <DATA>badpixfile</DATA>
	  <DATA>
	    The bad-pixel file for an observation. If set to CALDB then
	    the bad-pixel file in the Chandra CalDB will be used rather
	    than the observation-specific version. If set to NONE then
	    the instrument map, and hence exposure map, will be created
	    with no bad pixels.
	  </DATA>
	</ROW>
	<ROW>
	  <DATA>maskfile</DATA>
	  <DATA>
	    The mask file for an observation.
	  </DATA>
	</ROW>
	<ROW>
	  <DATA>dtffile</DATA>
	  <DATA>
	    The Dead-Time Factor correction file for HRC observations.
	  </DATA>
	</ROW>
      </TABLE>

      <PARA>
	The only required information is that provided by the
	aspect solution file(s); any other file can be ignored,
	(either explicitly, by setting the parameter to NONE, or
	implicitly because it can not be found), in which case the appropriate
	correction or information is ignored.
      </PARA>
    </ADESC>

    <ADESC title="Processing steps">
      <PARA>
	An overview of how &mname; works:
      </PARA>

      <LIST>
	<ITEM>
	  The event files are checked to ensure they are all
	  for the same instrument (ACIS-I and ACIS-S, HRC-I, or HRC-S).
	  Event files with no data - perhaps because of a ccd_id filter -
	  or that are for CC-mode observations are ignored.
	</ITEM>

	<ITEM>
	  The ancillary files for these observations are found,
	  if not given explicitly given, and matched up with the observations.
	</ITEM>

	<ITEM>
	  The reference position is either calculated from the data or taken
	  from the refcoord parameter.
	</ITEM>

	<ITEM>
	  A summary of the observations is displayed; e.g. time taken, observation
	  length, and several other useful details such as the focal-plane temperature (for ACIS),
	  SIM position, and separation from the reference position.
	</ITEM>

	<ITEM>
	  The event files are reprojected to the new reference position,
	  or copied if no reprojection is needed.
	</ITEM>

	<ITEM>
	  The new events files are merged together to create a single
	  events file, where only those columns common to all the input files
	  are used.
	  This file can be used for further analysis but in most cases it
	  should not be used for spectral analysis; the individual files should be used
	  instead.
	</ITEM>

	<ITEM>
	  For each new event, file images, exposure maps, exposure-corrected
	  images, and an optional PSF map
          are created for the requested list of bands.
	  An optional thresholding step is applied to both the
	  image and exposure map when the expmapthresh
	  parameter is set.
	  This step is similar to running fluximage on each observation.
	</ITEM>

	<ITEM>
	  For each band, the counts images and exposure maps are summed,
	  and used to create exposure-corrected images,
	  one per band. Any observation PSF maps are combined together,
          using the psfmerge-defined scheme, to create the output
          PSF map per band.
	</ITEM>

      </LIST>

      <PARA title="How do &mname;, &rname;, and &fname; work together">
	The &mname; script can be considered to be a run of &rname; followed
	by &fname; on all the reprojected events files. That is
      </PARA>

      <PARA>
	<SYNTAX>
	  <LINE>&upr; &mname; "*/repro/" out/</LINE>
	</SYNTAX>
      </PARA>

      <PARA>is equivalent to</PARA>

      <PARA>
	<SYNTAX>
	  <LINE>&upr; &rname; "*/repro/" out/</LINE>
	  <LINE>&upr; &fname; out/ out/</LINE>
	</SYNTAX>
      </PARA>
      <PARA>
	although the latter also creates links (or copies over) the ancillary
	files to out/. The advantage to using &rname; and &fname; rather than
	&mname; is that you have more control: e.g. if you do not want the
	exposure-corrected images you can just use &rname;, or you can do the
	reprojection once and then run &fname; multiple times with different
	bin sizes or grids.
      </PARA>
    </ADESC>

    <ADESC title="Converting merge_all to &mname;">
      <PARA>
	Most of the parameters used in merge_all do not need to be specified
	when running &mname;, since it calculates sensible values for them
	given the input data.
	For instance the command
      </PARA>

<VERBATIM>
&upr; merge_all @evt.all.lis @asol.lis chip=2,3,5,6,7 energy=2.3 \
       refcoord="123.45 -23.78" xygrid="2000.5:6728.5:8,3168.5:5824.5:8" \
       merged=out/merged.evt expmap=out/merged.emap expcorr=out/merged.fluxed
</VERBATIM>

      <PARA>
	- where the entries in evt.all.lis include the energy filter
	"[energy=500:7000]" -
	can be replaced by
      </PARA>

      <PARA>
	<SYNTAX>
	  <LINE>&upr; &mname; @evt.lis out/</LINE>
	</SYNTAX>
      </PARA>

      <PARA>
	or
      </PARA>

      <PARA>
	<SYNTAX>
	  <LINE>&upr; &rname; @evt.lis out/</LINE>
	</SYNTAX>
      </PARA>

      <PARA>
	depending on whether or not you want the exposure map and
	exposure-corrected image. Note that the files in
	evt.lis should not include any energy
	filter (the default band for ACIS data is 0.5 to 7.0 keV).
	If you wish to over-ride the script - e.g. to specify a tangent point
	or output grid - then you can.
      </PARA>

      <PARA>
	The following table lists the merge_all parameters and their
	equivalents in &mname;. It does not describe the new parameters.
      </PARA>

      <TABLE>
	<CAPTION>Comparison of parameters</CAPTION>
	<ROW>
	  <DATA>merge_all</DATA><DATA>&mname;</DATA><DATA>Description</DATA>
	</ROW>
	<ROW>
	  <DATA>evtfile</DATA><DATA>infiles</DATA>
	  <DATA>
	    As the energy filtering is now specified by the bands parameter,
	    so no energy filter should be applied to the individual observations. You can
	    now also include additional filters, so infiles="@evt.lis[ccd_id=0:3]"
	    or infiles="*/repro/*evt*[ccd_id=7]" are both valid.
	    The event files no longer need to be sorted by time.
	  </DATA>
	</ROW>
	<ROW>
	  <DATA>asol</DATA><DATA>asolfiles</DATA>
	  <DATA>
	    This parameter is no longer required since, if not given, the
	    script uses the ASOLFILE keyword in each event file to find the
	    aspect solution file (or files). This parameter only needs to be
	    given if the aspect solution files have been renamed (e.g. because you
	    have updated them to match WCS solutions between observations) or
	    moved, and have not updated the ASOLFILE keyword in the header.
	    The files no longer need to be sorted by time.
	  </DATA>
	</ROW>
	<ROW>
	  <DATA>dtffile</DATA><DATA>dtffiles</DATA>
	  <DATA>
	    This parameter is no longer required for HRC data since it is
	    found from the DTFFILE keyword in each event file. It only needs
	    to be specified if you have moved or renamed these files and have
	    not updated the DTFFILE keyword in the header.
	  </DATA>
	</ROW>
	<ROW>
	  <DATA>chip</DATA><DATA/>
	  <DATA>
	    There is no equivalent parameter in &mname;. If you wish to
	    restrict the chips used then apply a filter to the input event
	    files - e.g. "infiles=@evt.lis[ccd_id=0:3]".
	  </DATA>
	</ROW>
	<ROW>
	  <DATA>refcoord</DATA><DATA>refcoord</DATA>
	  <DATA>
	    This parameter is no longer required. If not given, a reference
	    position will be calculated given the tangent points of all the
	    input event files.
	  </DATA>
	</ROW>
	<ROW>
	  <DATA>xygrid</DATA>
	  <DATA>xygrid</DATA>
	  <DATA>
	    This parameter is no longer required. If not given, the extents of
	    the reprojected event files will be calculated and the union of them
	    used to chose a grid that covers all the data.
	    In this case the binning size is chosen by either the maxsize
	    or binsize parameter.
	  </DATA>
	</ROW>
	<ROW>
	  <DATA>energy</DATA><DATA>bands</DATA>
	  <DATA>
	    The choice of energy range is now given by the bands parameter,
	    which specifies both the energy range and the energy at which to
	    evaluate the energy map or the weighting file to use.
	    This means that energy filters should no longer be included on
	    the event files sent in to the infiles parameter.
	    It is also possible to specify multiple bands in one run
	    of &mname;.
	  </DATA>
	</ROW>
	<ROW>
	  <DATA>merged</DATA><DATA/>
	  <DATA>
	    The name of the merged event file is either
	    &lt;outroot&gt;/merged_evt.fits or
	    &lt;outroot&gt;_merged_evt.fits, depending on whether
	    the outroot parameter ends in a '/' or not. The &mname;
	    script will create this directory if it does not exist.
	  </DATA>
	</ROW>
	<ROW>
	  <DATA>expmap</DATA><DATA/>
	  <DATA>
	    The name of the combined exposure map is either
	    &lt;outroot&gt;/&lt;band&gt;_thresh.expmap or
	    &lt;outroot&gt;_&lt;band&gt;_thresh.expmap, depending on whether
	    the outroot parameter ends in a '/' or not.
	    If you do not want to create the combined images and exposure
	    maps then use the &rname; script instead, which just does
	    the reprojection and merging of the event files.
	  </DATA>
	</ROW>
	<ROW>
	  <DATA>expcorr</DATA><DATA/>
	  <DATA>
	    The name of the combined exposure-corrected image is either
	    &lt;outroot&gt;/&lt;band&gt;_flux.img or
	    &lt;outroot&gt;_&lt;band&gt;_flux.img, depending on whether
	    the outroot parameter ends in a '/' or not.
	    If you do not want to create the combined images and exposure
	    maps then use the &rname; script instead, which just does
	    the reprojection and merging of the event files.
	  </DATA>
	</ROW>
	<ROW>
	  <DATA>intdir</DATA><DATA>tmpdir</DATA>
	  <DATA>
	    The &mname; script is more careful about naming temporary files
	    and cleaning up after itself when an error occurs.
	  </DATA>
	</ROW>
      </TABLE>

    </ADESC>

    <ADESC title="Changes in the scripts 4.14.0 (December 2021) release">
      <PARA>
	When using the maxsize parameter, the calculated pixel size is now
	adjusted so that it does not have excessive precision: for instance
	a pixel size of 4.2 is now used rather than 4.19140625. This should
	allow the use of both the maxsize and the psfecf parameters (prior
	to this the combination could cause the script to fail).
      </PARA>
    </ADESC>

    <ADESC title="Changes in the scripts 4.13.1 (March 2021) release">
      <PARA title="Ignore the frame-store shadow region">
	The frame-store shadow is now included when calculating the
	instrument map for ACIS observations. This means that a small number
	of rows of the instrument and exposure maps are now excluded,
	to match the data processing. Please see the
	<HREF link="https://cxc.cfa.harvard.edu/ciao4.13/caveats/acis_shadow_badpix.html">ACIS
	frame-store caveat</HREF> for more information.
      </PARA>
    </ADESC>

    <ADESC title="Changes in the scripts 4.13.0 (December 2020) release">
      <PARA>
	The warning message about not using the merged event file for
	calculating instrument responses now restricts the message so
	that the value does not include excess precision, but is
	limited to the limit value. The tangent point in the screen
	output has also seen its accuracy reduced (this only affects
	the screen output).
      </PARA>
    </ADESC>

    <ADESC title="Changes in the scripts 4.12.2 (April 2020) release">
      <PARA>
	The script has been updated to support aspect solutions produced
	in the DS 10.8.3 release (or later). These files have a CONTENT
	keyword of ASPSOLOBI (earlier releases use ASPSOL), and can be
	used with skyfov when method=convexhull.
      </PARA>
    </ADESC>

    <ADESC title="Changes in the scripts 4.11.1 (December 2018) release">
      <PARA>
        The script will now create PSF maps for the observations if the
        psfecf parameter is set. The combined PSF map can be created
        using a variety of merging rules, such as weighting by the
        exposure time or using the minimum value.
      </PARA>
    </ADESC>

    <ADESC title="Changes in the scripts 4.8.2 (January 2016) release">
      <PARA>
	The random parameter has been added. It is used to control the
	random parameter of reproject_events when background subtracting
	HRC-I data.
      </PARA>
    </ADESC>

    <ADESC title="Changes in the scripts 4.8.1 (December 2015) release">
      <PARA>
        The code has been updated to avoid warning messages from
        NumPy version 1.9. There is no difference to how the
        script behaves.
      </PARA>
    </ADESC>

    <ADESC title="Changes in the scripts 4.7.3 (June 2015) release">
      <PARA title="Order of DTF files">
	It is no longer necessary, when giving
	the DTF files explicitly (rather than the
	suggested approach of using the DTFFILE keyword
	in the event file), to give the files in the
	same order as the
	event files are given to the infiles parameter.
      </PARA>
      <PARA title="Improved support for multi-obi datasets">
	The script is now able to work with
	<HREF link="https://cxc.harvard.edu/ciao/why/multiobi.html">multi-obi datasets</HREF>
	that have been processed by
	<HREF link="https://cxc.harvard.edu/ciao/ahelp/splitobs.html">splitobs</HREF>
	and then
	<HREF link="https://cxc.harvard.edu/ciao/ahelp/chandra_repro.html">chandra_repro</HREF>.
      </PARA>
    </ADESC>

    <ADESC title="Changes in the scripts 4.6.6 (September 2014) release">
      <PARA title="Reprojecting observations">
	Observations will only be reprojected if the tangent point
	shift is larger than 0.05 arcseconds, otherwise the original
	event file is copied.
      </PARA>
      <PARA title="Warning about different tangent points">
	The script will now only warn if the tangent points of two
	files differ by more than 0.05 arcsec.
      </PARA>
    </ADESC>

    <ADESC title="Changes in the scripts 4.6.5 (June 2014) release">
      <PARA title="Filtering the aspect solution by the event file GTI">
	The skyfov is run in order to calculate the sky range covered
	by each observation; e.g. see
	<HREF
	    link="https://cxc.harvard.edu/ciao/ahelp/get_fov_limits.html">ahelp
	get_fov_limits</HREF>. The aspect solutions are now filtered
	by the good-time intervals (GTI) of the event file - that is, the script sets
	<EQUATION>aspect=asol1.fits[@evt.fits]</EQUATION>
       (assuming the aspect solution is called asol1.fits and the
       event file evt.fits) when calling skyfov. This should not
       change most results but may produce slightly-smaller
       output images in cases where the GTI of the observation
       covers only a small fraction of the aspect solution.
      </PARA>


      <PARA title="HRC-I analysis">
	It is now possible to apply a PI filter range for the
	images by specifying PI limits in the bands parameter, that
	is bands=30:200:1.2 will use a PI range of 30 to 200
	when creating all the imaging products. The monochromatic
	energy used for the instrument map is still given in keV,
	so 1.2 keV in this example.
      </PARA>
      <PARA>
	A new subtraction method, which scales the
	background to match the data using the ratio of the
	counts in the band PI=300:500 (this can be
	changed with the new bkgparams parameter), can be selected by setting
	method=particle. The default method uses the exposure
	times of the observation and particle background files for
	the scaling.
	The scaling method and factor are added to the relevant files
	using the BKGMETH and BKGSCALE keywords, respectively.
      </PARA>
      <PARA>
	The status filter used to filter the HRC-I particle background
	file is now included in the screen output at the default
	verbosity level and added to the particle background
	files (retained when cleanup=no) using the STATFILT keyword.
	The background-unsubtracted files retained when cleanup=no
	now match the documentation (rather than include the
	typo 'undsubtracted').
      </PARA>
    </ADESC>

    <ADESC title="Changes in the scripts 4.6.2 (February 2014) release">
      <PARA>
        There have been some internal changes to try and avoid
        incompatibilities between CIAO and FTOOLS parameter files.
      </PARA>
      <PARA title="Setting maskfile to NONE">
	The bug which meant that maskfile could not be set to "NONE"
	has been fixed.
      </PARA>
    </ADESC>

    <ADESC title="Changes in the scripts 4.6.1 (December 2013) release">
      <PARA title="Removal of the pbkfiles parameter">
	The pbkfiles parameter has been removed as these files are no longer needed
	to run mkinstmap on ACIS observations.
	This means that it is no longer possible to turn off the
	<HREF link="https://cxc.harvard.edu/ciao/why/acisdeadarea.html">ACIS dead-area correction</HREF>
	for the exposure map; users who need this flexibility
	will have to generate the exposure maps manually (e.g.
	the
	<HREF link="https://cxc.harvard.edu/ciao/threads/expmap_acis_single/">ACIS single-chip thread</HREF>).
      </PARA>
      <PARA>
	For old data sets the removal of the pbkfile parameter can lead to
	error messages about missing keywords;
	in this case please download the latest archive version of your
	observation with download_chandra_obsid and then reprocess with chandra_repro.
      </PARA>
    </ADESC>

    <ADESC title="Changes in the scripts 4.5.4 (August 2013) release">
      <PARA>
        The description of the bands parameter has been updated to point out
        that when using the explicit format - e.g. a:b:c - for an energy band
        then the a and b values are required for ACIS data but should not be
        set for HRC data.
      </PARA>
      <PARA>
        The handling of files with a DataModel filter has been improved.
      </PARA>
    </ADESC>

    <ADESC title="Changes in the scripts 4.5.3 (June 2013) release">
      <PARA title="Supplying ancillary files">
	This release fixes a bug introduced in the scripts 4.5.2 release
	which meant the script could fail with an obscure error
	message ('ObsInfo' object has no attribute 'cycle') when
	given a stack of files for the ancillary files, such
	as the badpixfile parameter.
      </PARA>
    </ADESC>

    <ADESC title="Changes in the scripts 4.5.2 (April 2013) release">
      <PARA title="Handling HRC data">
	When merging HRC files, the sub-spaces of
	several columns - including CLKTICKS, AV1, and AU1 -
	have been removed to avoid the possibility of creating
	multiple GTI blocks. See the
	<HREF link="https://cxc.harvard.edu/ciao/caveats/hrc_subspace.html">HRC subspace caveat</HREF>
	for more information.
      </PARA>
      <PARA>
	The script will now warn you if the HRC observations contain
	old and new data, in which the defnition of the PI column
	has changed. If you see this warning we strongly advise
	you to reprocess the old dataset(s) with chandra_repro
	and re-do your analysis.
      </PARA>
      <PARA title="Event file selection">
	The script now skips event files which have an OBS_ID keyword
	of "Merged".
      </PARA>
      <PARA title="Interleaved mode data">
	The script will now include both the primary and secondary cycles (i.e. the "e1" and "e2" forms)
	of ACIS interleaved mode data.
	Previously it would just select one of the files (generally the
	"e1", which is the shorter of the two). If you only want to include one of the
	cycles then use an explicit list of observations.
	When processing interleaved-mode data, file names are labelled as
	"&lt;obsid&gt;e1"
	or
	"&lt;obsid&gt;e2".
      </PARA>
      <PARA title="Aspect solutions">
	The program now checks that the aspect-solution files are
	not aspect histograms.
      </PARA>
      <PARA title="Improved warnings and errors">
	The handling of missing ancillary files has been improved; if
	none of a particular type - such as the mask file - can be found then
	the program runs as if you has set that parameter to 'NONE', otherwise
	the error message now tells you what observation was missing a file.
      </PARA>
    </ADESC>

    <ADESC title="Changes in the scripts 4.5.1 (December 2012) release">
      <PARA>
	The script has been updated to work in CIAO 4.5.
      </PARA>
    </ADESC>

    <ADESC title="About Contributed Software">
      <PARA>
        This script is not an official part of the CIAO release but is
        made available as "contributed" software via the
        <HREF link="https://cxc.harvard.edu/ciao/download/scripts/">CIAO scripts page</HREF>.
        Please see this page for installation instructions - such as how to
        ensure that the parameter file is available.
      </PARA>
    </ADESC>

    <BUGS>
      <PARA>
	See the
	<HREF link="https://cxc.harvard.edu/ciao/bugs/&mname;.html">bugs page
	for this script</HREF> on the CIAO website for an up-to-date
	listing of known bugs.
      </PARA>
    </BUGS>
    <LASTMODIFIED>December 2021</LASTMODIFIED>
  </ENTRY>
</cxchelptopics>
