<?xml version="1.0"?>
<!DOCTYPE cxchelptopics SYSTEM "CXCHelp.dtd" [

 <!ENTITY pr "unix&#37;">

]>

<cxchelptopics>
  <ENTRY key="chandra_repro" context="Tools::Composite" refkeywords="repro reprocessing createl2">

    <SYNOPSIS>
      Reprocess a Chandra dataset
    </SYNOPSIS>

    <DESC>
      <PARA>
	The chandra_repro reprocessing script automates the
	recommended data processing steps presented in the CIAO
	analysis threads.  The script reads data from the standard
	data distribution (e.g. primary and secondary directories) and
	creates a new bad pixel file, a new level=2 event file, and a
	new level=2 Type II PHA file with the appropriate response files (grating data only).
      </PARA>

      <PARA>
	chandra_repro may be used to reprocess any ACIS and HRC imaging
	or grating data.  
      </PARA>

      <PARA> 
	There are parameters to control certain reprocessing steps,
	such as creating the new bad pixel file or destreaking the
	data.  Users who wish to have finer-grained control over the
	reprocessing parameters should instead follow the
	step-by-step instructions in
	the <HREF link="https://cxc.harvard.edu/ciao/threads/data.html">CIAO
	Data Preparation Threads</HREF>.
      </PARA>

      <PARA title="Where are the processed files?">
	The chandra_repro script stores the processed files in the location
	given by the outdir parameter. This can be relative to the input directory
	- e.g. a repro/ directory within each obsid - or everything can be
	placed into a single directory (when processing multiple directories).
	The grating products - PHA2, grating ARFs, and RMFs - 
	are placed in the tg/ subdirectory of the outroot
	directory.
      </PARA>
 
     <PARA title="CALDB Version">
     The chandra_repro script does not overwrite the CALDBVER keyword in
     the event header since not all calibrations may have been applied.
     However, it does record the version of the CALDB in comments that 
     users can check to verify that they applied the intended 
     calibration updates.     
     </PARA>
<VERBATIM>
&pr; dmlist acis_repro_evt2.fits header | grep 'chandra_repro was run' 
 --  COMMENT               chandra_repro was run with CALDB 4.5.1
 --  HISTORY               PARM  :value=chandra_repro was run with CALDB 4.5.1            ASC00639
</VERBATIM>
 
 
   </DESC>

    <QEXAMPLELIST>
      <QEXAMPLE>
	    <SYNTAX>
	      <LINE>&pr; chandra_repro</LINE>
	    </SYNTAX>
	<DESC>

	  <PARA>
	    Reprocess the dataset in the current working directory
	    with the default script settings. The default verbosity of
	    1 means that status messages will be printed to the
	    screen. 
	  </PARA>

	  <PARA>
	    The script should be run from directory which contains the
	    contains the primary/ and secondary/ data directories from
	    a standard Chandra Data Archive download tarfile:
	  </PARA>

<VERBATIM>
&pr; pwd
/data/1838/

&pr; ls
primary/  secondary/
</VERBATIM>
	</DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	    <SYNTAX>
	      <LINE>&pr; chandra_repro verbose=0</LINE>
	    </SYNTAX>
	<DESC>

	  <PARA>
	    Reprocess the dataset in the current working directory
	    with the default settings.  Nothing will be printed to the
	    screen, unless the script detects an error. 
	  </PARA>
	</DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	    <SYNTAX>
	      <LINE>&pr; chandra_repro indir=/data/1838 outdir=/data/1838/new cleanup=no</LINE>
	    </SYNTAX>

	<DESC>
	  <PARA>
	    Reprocess the dataset in directory /data/1838, writing the
	    new files to /data/1838/new .  Save all of the
	    intermediate files (cleanup=no).
	  </PARA>
	</DESC>
      </QEXAMPLE>

      <QEXAMPLE>
	    <SYNTAX>
	      <LINE>&pr; chandra_repro set_ardlib=no</LINE>
	    </SYNTAX>

	<DESC>
	  <PARA>
	    The data will be reprocessed, but the bad pixel filename
	    will not be set in ardlib.par.  
	  </PARA>

	</DESC>
      </QEXAMPLE>

      <QEXAMPLE>
        <DESC>
<!-- use a verbatim block to retain the spacing/blank characters -->
<VERBATIM>
&pr; chandra_repro verbose=1 mode=h
Resetting afterglow status bits in evt1.fits file...

Running acis_build_badpix and acis_find_afterglow to create a new bad pixel file...

Running acis_process_events to reprocess the evt1.fits file...
Filtering the evt1.fits file by grade and status...
Applying the good time intervals from the flt1.fits file...
The new evt2.fits file is: /data/1838/repro/acisf01838_repro_evt2.fits

Updating the event file header with chandra_repro HISTORY record
Setting observation-specific bad pixel file in local ardlib.par.

Cleaning up intermediate files

WARNING: Observation-specific bad pixel file set for session use:
         /data/1838/repro/acisf01838_repro_bpix1.fits
         Run 'punlearn ardlib' when analysis of this dataset completed.

The data have been reprocessed.
Start your analysis with the new products in
/data/1838/repro
</VERBATIM>
	<PARA>
	  At the verbose=0 setting, only critical warnings and
	  errors are printed to the terminal.  At verbose=1 (and above) 
	  additional information about each data set is printed.
	</PARA>
	</DESC>
      </QEXAMPLE>



      <QEXAMPLE>
            <SYNTAX>
             <LINE>&pr; chandra_repro indir=1838,1839 outdir="" </LINE>
	    </SYNTAX>
        <DESC>
	  <PARA>
	    Will reprocess the data in directories 1838/ and 1839/.  The outputs will be
	     placed in 1838/repro and 1839/repro.  A warning will be issued since multiple 
	     indir are used and the default set_ardlib=yes are incompatible (see details below).
	     The data are not reprojected to the tangent plane, nor are they corrected for 
	     any small astrometric shifts.
	  </PARA>



	</DESC>
      </QEXAMPLE>


      <QEXAMPLE>
            <SYNTAX>
             <LINE>&pr; chandra_repro "*" outdir="" </LINE>
	    </SYNTAX>
        <DESC>
	  <PARA>
        chandra_repro will try to process all the obsids in the
        current directory.  The "*" must be in quotes (single or double)
        or must be escaped, \*, from the shell.  All other stack
        expansion rules also apply (see ahelp stack).
	  </PARA>
      <PARA>
        The default outroot parameter is set such that a "repro" directory
        will be created in each obsid's subdirectory. 
      </PARA>
<VERBATIM>
&pr; download_chandra_obsid 1838 
...
&pr; /bin/ls 
1838
&pr; chandra_repro "*" mode=h verb=1

Processing input directory '/data/1838'

Resetting afterglow status bits in evt1.fits file...

Running acis_build_badpix and acis_find_afterglow to create a new bad pixel file...

Running acis_process_events to reprocess the evt1.fits file...
...
&pr; /bin/ls 1838/*
1838/axaff01838N002_VV001_vv2.pdf  1838/oif.fits

1838/primary:
acisf01838_000N003_bpix1.fits.gz  acisf01838N003_full_img2.fits.gz
acisf01838_000N003_fov1.fits.gz   acisf01838N003_full_img2.jpg
acisf01838N003_cntr_img2.fits.gz  orbitf084197100N001_eph1.fits.gz
acisf01838N003_cntr_img2.jpg      pcadf084244404N003_asol1.fits.gz
acisf01838N003_evt2.fits.gz

1838/repro:
acisf01838_000N003_bpix1.fits  acisf01838_asol1.lis
acisf01838_000N003_fov1.fits   acisf01838_repro_bpix1.fits
acisf01838_000N003_msk1.fits   acisf01838_repro_evt2.fits
acisf01838_000N003_mtl1.fits   acisf084245776N003_pbk0.fits
acisf01838_000N003_stat1.fits  pcadf084244404N003_asol1.fits

1838/secondary:
acisf01838_000N003_evt1.fits.gz     acisf084244478N003_3_bias0.fits.gz
acisf01838_000N003_flt1.fits.gz     acisf084244478N003_4_bias0.fits.gz
acisf01838_000N003_msk1.fits.gz     acisf084244478N003_5_bias0.fits.gz
acisf01838_000N003_mtl1.fits.gz     acisf084245776N003_pbk0.fits.gz
acisf01838_000N003_stat1.fits.gz    aspect
acisf084244478N003_0_bias0.fits.gz  axaff01838N002_VV001_vvref2.pdf.gz
acisf084244478N003_1_bias0.fits.gz  ephem
acisf084244478N003_2_bias0.fits.gz
</VERBATIM>


	</DESC>
      </QEXAMPLE>

    <QEXAMPLE>
        <SYNTAX>
         <LINE>&pr; chandra_repro 23206 outdir="" tg_zo_position="83.8156671,-5.3861617"</LINE>
	    </SYNTAX>
        <DESC>
            <PARA>
            By default chandra_repro will use the 0th order location taken
            from the standard Level2 event file, primary/*evt2.fits file.
            This will be for the brightest source.  However, users can
            optionally supply the celestial coordinates for the 
            source to use for the 0th order location.  In this example
            we run chandra_repro with the RA and Dec coordinates for
            the source specified in decimal degrees.  Users can also
            supply the coordinates in sexagesimal notation, e.g.
<SYNTAX>
<LINE>
tg_zo_position="5:35:15.7594,-5:23:10.191"
</LINE>
</SYNTAX>
            </PARA>

        </DESC>
    </QEXAMPLE>


    </QEXAMPLELIST>


    <PARAMLIST>
      <PARAM name="indir" def="./" type="file" reqd="yes" stacks="yes">
        <SYNOPSIS>
	  Input directory
        </SYNOPSIS>
        <DESC>
          <PARA>
	    The directory which contains the primary/ and secondary/
	    data directories from a standard Chandra Data Archive
	    download tarfile.   It may also be a directory which
	    contains all of the downloaded data files (i.e. not
	    organized into primary/ and secondary/ subdirectories).
          </PARA>

	  <PARA title="Special Input Case: multi-OBI data">
	    In order to run chandra_repro on observations that
	    have multiple observation intervals
	    (<HREF link="https://cxc.harvard.edu/ciao/dictionary/obi.html">OBIs</HREF>), 
	    the input data
	    has to be separated into different input directories.  
	    Users can refer to the
            <HREF link="https://cxc.harvard.edu/ciao/why/multiobi.html">Multi-OBI
	      Observations why topic</HREF> for information on what
	    these datasets are, and the
	    <HREF link="https://cxc.harvard.edu/ciao/ahelp/splitobs.html">splitobs</HREF>
	    script to create separate directories for the different OBIs.
	  </PARA>	  
	  <PARA title="Interleaved-mode datasets">
	    The chandra_repro script can be run on
	    <HREF link="https://cxc.harvard.edu/ciao/dictionary/altexp.html">interleaved mode</HREF>
	    datasets. In this case, the output files will use the
	    labels "e1" and "e2" to separate the two sets of outputs.
	    Alternately, the
	    <HREF link="https://cxc.harvard.edu/ciao/ahelp/splitobs.html">splitobs</HREF>
	    script can be used to create separate directories for the 
	    primary (e1) and secondary (e2) data periods, after which the
	    data can be processed as separate datasets.
	  </PARA>
	  <PARA title="Multiple Datasets">
	    indir can be a 
	    <HREF link="https://cxc.harvard.edu/ciao/ahelp/stack.html">stack</HREF> 
	    of input directories.  Each subdirectory will be processed one at a time; 
	    each must have the primary and secondary directories.  See the outdir 
	    parameter for details on where reprocessed products will be created.  
	    Note:  since there is only one ardlib.par, the set_ardlib parameter 
	    is forced to be "no" since it cannot be set correctly for all 
	    directories.  Multiple inputs are NOT reprojected to the same
	     tangent plane nor are they corrected for astrometric shifts.  

	  </PARA>

        </DESC>
      </PARAM>

      <PARAM name="outdir" def="&quot;&quot;" type="file" reqd="yes">
        <SYNOPSIS>
	  Output directory
        </SYNOPSIS>
        <DESC>
          <PARA>
	    The output directory for the reprocessed data files.  This
	    directory will also contain symbolic links to the files
	    which are required for data analysis, e.g. the aspect
	    solution and the mask file.  If the file system does not
	    support symbolic links then copies are made.
          </PARA>
	  <PARA>
	  The default, outdir="", will create a "repro" subdirectory underneath the indir directory.
	  </PARA>
	  <PARA title="Multiple Datasets">
	  	    When the indir parameter is a stack, the outdir must 
		    be specified in one of the following ways.  If outdir="", then a
		     "repro" subdirectory will be created in each indir in the stack.
		       If outdir="./repro", or any other single directory name, then
		        all the outputs from all the indirs will be put into the same 
			directory.  Finally, users can specify a stack of outdirs that 
			match one-to-one with the indirs for the most control over the 
			location of where each indir goes.
	  </PARA>

        </DESC>
      </PARAM>

      <PARAM name="root" type="string" reqd="no">
        <SYNOPSIS>
	  Root for output filenames
        </SYNOPSIS>
        <DESC>
          <PARA>
	    If not specified, the script uses the first section of the 
	    level=1 event filename (up to the first underscore) to
	    define the root, e.g. "acisf01838" is the root of
	    acisf01838_000N002_evt1.fits. 
          </PARA>

	  <PARA>
	    New files that are created by the script have the filename
	    format &lt;root&gt;_repro_&lt;type&gt;.fits,
	    e.g. acisf01838_repro_evt2.fits or
	    acisf01838_000N003_bpix1.fits.
	  </PARA>
        </DESC>
      </PARAM>

      <PARAM name="badpixel" def="yes" type="boolean" reqd="no">
        <SYNOPSIS>
	  Create a new bad pixel file?
        </SYNOPSIS>
        <DESC>
          <PARA>
	    If "badpixel=yes" (the default), a new bad pixel file is
	    created for the dataset. 
          </PARA>

	  <LIST>
	    <CAPTION>ACIS Data:</CAPTION>
	    <ITEM>status bits 1-5, 14-20 and 23 in the input event
	    file are reset by the acis_clear_status_bits script to
	    remove any previous bad pixel identification and
	    destreaking.</ITEM>   

	    <ITEM>destreak is run to identify streak events, if the
	      observation used ACIS-S4 (ccd_id=8) and destreak=yes.
	      Flagging the streaks first prevents the misidentification of
              pixels with a lot of streak events as being hot pixels.</ITEM> 
	    
	    <ITEM>acis_build_badpix and acis_find_afterglow are run to
	    create a new bad pixel file which flags hot pixel and
	    afterglow events in the event file.</ITEM>  
	  </LIST>

	  <LIST>
	    <CAPTION>HRC Data:</CAPTION>
	    <ITEM>hrc_run_hotpix is run to define the valid coordinate
	      regions in the detectors and to identify hot pixels in
	      the event file.</ITEM>  
	  </LIST>

	  <PARA>
	    The new bad pixel that is created is used in reprocessing
	    the data, assuming "process_events=yes".
	  </PARA>

	  <PARA title="ACIS continuous-clocking mode">
	    This parameter setting does not apply when the input data
	    were taken in ACIS continuous-clocking mode, as the
	    ACIS afterglow and hot pixel tool cannot be used with this data mode.
	  </PARA>

	  <PARA title="Related webpages:">
	    o) <HREF link="https://cxc.cfa.harvard.edu/ciao/threads/acisbadpixels/">
        Customizing an ACIS Bad Pixel File (experts only)
        </HREF>
	  </PARA>

	  <PARA>
	    o) <HREF link="https://cxc.harvard.edu/ciao/threads/hrc_badpix/">New
	     Observation-Specific HRC Bad Pixel File thread</HREF>
	  </PARA>

        </DESC>

      </PARAM>

      <PARAM name="process_events" def="yes" type="boolean" reqd="no">
        <SYNOPSIS>
	  Create a new level=2 event file?
        </SYNOPSIS>
        <DESC>
          <PARA>
	    If "process_events=yes" (the default), then the
	    acis_process_events or hrc_process_events tool is run to
	    create a new level=1 event file with the latest
	    calibration applied.  
	  </PARA>

	  <PARA>
	    The standard grade, status, and good time filters are
	    applied by the tool dmcopy to create a new level=2 event
	    file.  This
	    includes <HREF link="https://cxc.cfa.harvard.edu/cal/Letg/Hrc_bg/">the
	    pulse-height filter to reduce background in LETG/HRC-S
	    observations</HREF>.  
          </PARA>

	  <PARA>
	    For grating data, a new level=2 Type II PHA file is extracted along
        with the ARF and RMF files which are stored in the tg/ subdirectory.
        
	  </PARA>
          
	  <LIST>
	    <CAPTION>ACIS Reprocessing Steps</CAPTION>
            <ITEM>the latest charge transfer inefficiency (CTI) correction</ITEM>
            <ITEM>the latest time-dependent gain adjustment</ITEM>
            <ITEM>the latest gain map</ITEM>
            <ITEM>a new bad pixel file</ITEM>
            <ITEM>PHA randomization</ITEM>
            <ITEM>a sub-pixel adjustment (if specified, see "pix_adj" parameter)</ITEM>
            <ITEM>clean the VFAINT background  (see "check_vf_pha" parameter)</ITEM>
            <ITEM>continuous clocking mode times of arrival and pulse heights</ITEM>
          </LIST>
          
	  <LIST>
	    <CAPTION>HRC Reprocessing Steps</CAPTION>
	    <ITEM>the latest time-dependent gain adjustment</ITEM>
	    <ITEM>the AMP_SF correction</ITEM>
	    <ITEM>the degap correction</ITEM>
	    <ITEM>recomputing average HRC dead time corrections</ITEM>
            <ITEM>pixel randomization (if specified, see "pix_adj" parameter)</ITEM>
          </LIST>

	  <PARA title="Related webpages:">
	    o) <HREF link="https://cxc.harvard.edu/ciao/threads/createL2/">Reprocessing Data to Create a New Level=2 Event File thread</HREF> 
          </PARA>
	  <PARA>
	    o) <HREF link="https://cxc.harvard.edu/ciao/ahelp/acis_process_events.html">acis_process_events
	    help file</HREF>
	  </PARA>
	  <PARA>
	    o) <HREF link="https://cxc.harvard.edu/ciao/ahelp/hrc_process_events.html">hrc_process_events
	    help file</HREF>
	  </PARA>
        </DESC>
      </PARAM>

      <PARAM name="destreak" def="yes" type="boolean" reqd="no">
        <SYNOPSIS>
	  Destreak the ACIS-8 chip?
        </SYNOPSIS>
        <DESC>
          <PARA>
	    There is a flaw in the serial readout of the ACIS chips,
	    causing a significant amount of charge to be randomly
	    deposited along pixel rows as they are read out. 
	    If "destreak=yes" (the default), the destreak tool is run
	    on the ACIS-S4 chip to detect probable streak events.  The  
	    flagged events are then filtered out of the new level=2
	    event file. 
          </PARA>

	  <PARA title="Related webpages:">
	    o) <HREF link="https://cxc.harvard.edu/ciao/why/destreak.html">Destreaking ACIS Data why topic</HREF>
	  </PARA>
	  <PARA>
	    o) <HREF link="https://cxc.harvard.edu/ciao/ahelp/destreak.html">destreak
	    help file</HREF>
	  </PARA>
        </DESC>
      </PARAM>

      <PARAM name="set_ardlib" def="yes" type="boolean" reqd="no">
        <SYNOPSIS>
	  Set ardlib.par with the bad pixel file?
        </SYNOPSIS>
        <DESC>
          <PARA>
	    If "set_ardlib=yes" (the default), the
	    observation-specific bad pixel file is set in
	    the ardlib.par file so that it is available to the CIAO
	    tools during data analysis.
          </PARA>

	  <PARA>
	    Setting "set_ardlib=no" may be useful if you are analyzing 
	    another dataset while chandra_repro is running.   In this
	    case, you would not want ardlib.par to be modified until
	    the other analysis tasks are finished.
	  </PARA>

	  <PARA>
	    Remember to "punlearn" your ardlib.par file after
	    completing analysis of this dataset to ensure that the
	    proper bad pixel maps are used the next time that
	    ardlib.par is referenced by a tool.  
	  </PARA>

	  <PARA title="Related webpages:">
	    o) <HREF link="https://cxc.harvard.edu/ciao/threads/badpix/">Setting
	    the Observation-specific Bad Pixel Files</HREF> 
	  </PARA>

	  <PARA title="Multiple datasets">
	    If there are multiple input datasets, then the single
	     ardlib.par cannot be setup correctly for all of them.  
	     Therefore chandra_repro script will omit this step if 
	     multiple input directories are used.
	  </PARA>

        </DESC>
      </PARAM>

      <PARAM name="check_vf_pha" def="no" type="boolean" reqd="no">
        <SYNOPSIS>
	  Clean ACIS background in VFAINT data?
        </SYNOPSIS>
        <DESC>
	  <PARA>
	    In ACIS very faint mode, acis_process_events can use the
	    pulse heights in the outer 16 pixels of the 5x5 event
	    island to help distinguish between good X-ray events and
	    bad events that are most likely associated with cosmic
	    rays.
	  </PARA>

          <PARA>
	    If "check_vf_pha=yes" (not the default), then the ACIS particle
	    background for very faint mode observations is cleaned.
	    The potential background event - events where one or more
	    of those outer pixels is greater than the default split
	    threshold - is flagged and filtered out of the event file.
          </PARA>

	  <PARA>
	  Prior to the June 2012 release, the default for check_vf_pha was
	  set to "yes".  It has been determined that this could remove
	  good events in observations with modestly bright point sources.
	  Therefore, the default is now set to "no".
	  </PARA>


          <PARA>
	    The value of this parameter is passed to the
	    "check_vf_pha" parameter of acis_process_events when
	    "process_events=yes".   
	  </PARA>

	  <PARA title="Related webpages:">
	    o) <HREF link="https://cxc.harvard.edu/ciao/why/aciscleanvf.html">ACIS
	    VFAINT Background Cleaning why topic</HREF> 
	  </PARA>
        </DESC>
      </PARAM>

      <PARAM name="pix_adj" def="default" type="string" reqd="no">
        <SYNOPSIS>
	  Pixel randomization: default|edser|none|randomize
        </SYNOPSIS>
        <DESC>
          <PARA>
	    If "pix_adj=default" (the default), then the default value of
           the tool's pixel randomization parameter is used.  For ACIS
           timed exposure mode data, a subpixel algorithm is applied
           (acis_process_events pix_adj=EDSER).  For ACIS
           continuous-clocking mode data, no subpixel adjustment is applied
           (acis_process_events pix_adj=NONE). For HRC data, randomization
           is not applied (hrc_process_events rand_pix_size=0.0).
          </PARA>

	  <PARA>
	    The following table summarizes the chandra_repro pix_adj
	    options and how each is passed to acis_process_events and
	    hrc_process events (when "process_events=yes").
	  </PARA>

	  <TABLE>
	    <ROW>
	      <DATA>pix_adj value</DATA>
	      <DATA>acis_process_events parameter</DATA>
	      <DATA>hrc_process_events parameter</DATA>
	    </ROW>

	    <ROW>
	      <DATA>default</DATA>
	      <DATA>pix_adj=EDSER (TE) or pix_adj=NONE (CC)</DATA>
	      <DATA>rand_pix_size=0.0</DATA>
	    </ROW>

	    <ROW>
	      <DATA>edser</DATA>
	      <DATA>pix_adj=EDSER</DATA>
	      <DATA>not applicable</DATA>
	    </ROW>

	    <ROW>
	      <DATA>none</DATA>
	      <DATA>pix_adj=NONE</DATA>
	      <DATA>rand_pix_size=0.0</DATA>
	    </ROW>

	    <ROW>
	      <DATA>randomize</DATA>
	      <DATA>pix_adj=RANDOMIZE</DATA>
	      <DATA>rand_pix_size=0.5</DATA>
	    </ROW>
	  </TABLE>

	  <PARA title="Related webpages:">
	    o) <HREF link="https://cxc.harvard.edu/ciao/why/acispixrand.html">ACIS 
	    Pixel Randomization why topic</HREF>
	  </PARA>
        </DESC>
      </PARAM>


      <PARAM name="tg_zo_position" def="evt2" type="string" reqd="no">
        <SYNOPSIS>
            How to determine the gratings 0th order location.
        </SYNOPSIS>
        <DESC>
          <PARA>
          The tg_zo_position parameter allows the user to choose how
          the gratings 0th order location is selected.  The options are:
          </PARA>
          <LIST>
            <ITEM>"evt2" : If tg_zo_positoin="evt2", the default, then
            chandra_repo will use the 0th order location 
            from the REGION block in the archived Level2 event file (located in the 
            primary/ directory).   This may be the best choice
            especially if the 0th order location was manually 
            adjusted by the Verification and Validation (V&amp;V) scientist.
            The region is defined in physical coordinates.   If data has been
            reprojected or if a fine astrometric shift has been added to 
            the aspect solution, this may invalidate the region coordinates.
            </ITEM>
            <ITEM>"detect" : If tg_zo_position="detect", then
            chandra_repro will run the tgdetect2 tool to detect
            the 0th order location.  This will use either tgdetect
            or tg_findzo to determine the source location.</ITEM>
            <ITEM>RA and Dec. coordinates : Lastly, users can 
            supply their own coordinates for the 0th order location. This
            may be needed if the source of interest is not the brightest
            source in the field.  The source position can specified in either 
            decimal degrees or in sexagesimal notation.
            </ITEM>
          </LIST>
    <PARA>
        See <HREF link="https://cxc.cfa.harvard.edu/ciao/ahelp/coords_format.html">
        ahelp coords_format</HREF> for example of the supported
        syntax.
    </PARA>

        <PARA>
        The 0th order location is used to create the gratings mask to
        determine which events are assigned gratings coordinates, and
        for the case of HETG, to assign events to the HEG or MEG arm.
        
        </PARA>

        <PARA title="Related webpages:">
            <HREF link="https://cxc.harvard.edu/ciao/threads/tg_piled_zero/">
            Source Position for Grating Data with a Piled or Blocked Zero Order 
            </HREF>
        </PARA>
        <PARA>
            <HREF link="https://cxc.cfa.harvard.edu/ciao/threads/tgdetect/">
            Correcting a Misplaced Zero-order Source Position.
            </HREF>
        </PARA>
        <PARA title="Multiple datasets">
            If the user runs chandra_repro with multiple datasets, then 
            the same position parameter option, including coordinates, 
            are used for each gratings dataset.        
        </PARA>
        </DESC>
      </PARAM>

      <PARAM name="asol_update" def="yes" type="boolean" reqd="no">
        <SYNOPSIS>
        Apply boresight correction to aspect solution file(s), if necessary.
        </SYNOPSIS>
        <DESC>
          <PARA>
           If this parameter is set to "yes" and the input aspect solution
           file has not already had the boresight correction applied, 
           then chandra_repro will run the asp_offaxis_corr tool 
           script to create an updated aspect solution file.          
           If the aspect solution file has already been corrected then
           this step is skipped.          
          </PARA>
          <PARA>
            The effect of the boresight correction is to update the 
            location of the aimpoint while preserving the celestial
            coordinates (RA and Dec) of the events.  The sky coordinates
            (X,Y) and detector coordinates (DETX, DETY) may change
            by as much as 30 arcsec based (typical changes are much
            smaller).          
          </PARA>          
        </DESC>
      
      </PARAM>

      <PARAM name="pi_filter" def="yes" type="boolean" reqd="no">
         <SYNOPSIS>
          Should the additional PI filter be applied to HRC-S+LETG data?
         </SYNOPSIS>
         <DESC>
            <PARA>
                This parameter controls whether the optional HRC-S+LETG
                PI filter should be used.  The PI filter is designed 
                to suppress the background with only minor effect on
                the source spectrum.
            </PARA>
         </DESC>     
      </PARAM>


      <PARAM name="patch_hrc_ssc" def="no" type="boolean" reqd="no">
        <SYNOPSIS>
            Look for evidence of HRC Secondary Science Corruption (SSC) and
            patch dead-time factors if detected.
        </SYNOPSIS>
        <DESC>
          <PARA>
             SSC results from a byte-shift anomaly which occasionally causes a
             portion of the housekeeping data to be corrupted.  The symptom is
             dropouts in the dead-time-factor (dtf) which can be seen in a plot
             of the dtf1 file's dtf valuse vs time, where the dtf is
             significantly (&gt;10%) below the median value (~1.0).
          </PARA>
        <PARA>
         Event data are good during the SSC times.  Standard data
         processing, however, will create multiple GTI intervals around the
         low dtf times, rejecting some events, and lowering the
         dead-time-correction factor (DTDOR).
        </PARA>
        <PARA>
          Note: telemetry saturation from a bright source can also 
          lower the dtf; however, this tends to be a more continuous and sustained
          lowering of the value.  
        </PARA>


        </DESC>
      </PARAM>



      <PARAM name="cleanup" def="yes" type="boolean" reqd="no">
        <SYNOPSIS>
	  Cleanup intermediate files on exit
        </SYNOPSIS>
        <DESC>
          <PARA>
	    If "cleanup=yes" (the default), intermediate data files
	    are deleted when the script ends.  When the parameter is
	    set to "no", these files remain in the "outdir"
	    directory. 
          </PARA>
        </DESC>
      </PARAM>


      <PARAM name="clobber" def="yes" type="boolean" reqd="no">
        <SYNOPSIS>
	  Clobber existing files?
        </SYNOPSIS>

	<DESC>
	  <PARA>
	    Overwrite existing files with the same filename?
	  </PARA>
	</DESC>
      </PARAM>

      <PARAM name="verbose" def="1" min="0" max="5" type="integer" reqd="no">
        <SYNOPSIS>
	  The amount of information printed to the screen
        </SYNOPSIS>
        <DESC>
          <PARA>
	    The default verbosity setting (1) prints status messages
	    as the script runs.  Higher verbosity settings print the
	    commands that are being run.  Setting verbose=0 turns off
	    all screen output except errors.
          </PARA>
        </DESC>
      </PARAM>
    </PARAMLIST>


<ADESC title="Changes in the scripts 4.17.1 (February 2025) release">
  <PARA>
    Adjusted the logic that deals with finding multiple file names for the
    same file type (eg two bad pixel files). If the files names differ only in the
    presence of the ".gz" suffix, then now the ".gz" file is ignored. Previously
    this would trigger an error.
  </PARA>
</ADESC>


<ADESC title="Changes in the scripts 4.17.0 (December 2024) release">
  <PARA title="New HRC Science Science Corruption tool">
    A new parameter has been added: patch_hrc_ssc, which when set to 
    "yes" will run the patch_hrc_ssc tool.  This tool looks for
    corruption in the HRC secondary science data and will replace (patch)
    the corrupted values in the dead time factors file. This typically results
    in a very slightly higher average DTCOR value and elimination of some
    very short, erroneously tagged bad time intervals.
  </PARA>
</ADESC>


<ADESC title="Changes in the scripts 4.16.2 (August 2024) release">
  <PARA title="On Board Computer (OBC) mode">
    Some observations, mostly of either the Earth or the Moon, were
    done without using the aspect camera to determine attitude and pointing.
    These observations rely on the On Board Computer (OBC) aspect 
    solution, osol1.fits.  This update allows chandra_repro to use the
    OBC solution files for these observations.  
  </PARA>
  <PARA title="Solar System Objects">
    This fixes a problem with some solar system objects, including
    the OBC mode objects, that have multiple aspect solution files;
    they must be merged into a single file before running sso_freeze.
    This change also makes a failure in sso_freeze non-fatal. The
    rest of the event processing will proceed if sso_freeze is unable to
    compute object-centered coordinates. This happens for most of the EARTH
    observations. 
  </PARA>
  <PARA title="Fix for older datasets">
    Internal change to how the r4_header_update script is run to 
    deal with observations that are missing the "*FILE" keywords needed
    to automatically locate the parameter block file and aspect solution
    file(s).
  </PARA>
</ADESC>

<ADESC title="Changes in the scripts 4.15.0 (December 2022) release">
  <PARA>
    A problem when multiple SSO eph1 files are found has been
    fixed.
  </PARA>
  <PARA>
    A bug in dmcopy prevented tgdetect2 from selecting the tg_findzo
    method.  A work-around has been implemented to allow it to do so.
  </PARA>

</ADESC>

<ADESC title="Changes in the scripts 4.14.2 (April 2022) release">
  <PARA title="Please read the V&amp;V report">
    The script now notes the location of the Verification and
    Validation (V&amp;V) report for each observation. Please read
    this, even if you decide not to run chandra_repro, as it is where
    possible issues in the observation are reported.
  </PARA>
  <PARA title="Specifying the zeroth-order location for grating observations">
    The parameter "recreate_tg_mask" has been replaced with the 
    "tg_zo_position" parameter.  For gratings datasets, users can now
    choose whether to use the 0th order location from the existing Level2 
    events file from the archive (tg_zo_position="evt2"), detect the
    zeroth order postion using tgdetect2 (tg_zo_position="detect"), or
    to supply the RA and Dec coordinates of the source location
    in either decimal degrees or sexagesimal notation.  
  </PARA>
  <PARA title="Solar System Object Observations">
    chandra_repro will now run sso_freeze on the event file and
    aspect solution file if it finds a solar system ephemeris file
    in the primary/ directory along with the definitive 
    ephemeris (orbit*_eph1.fits).  The solar system ephemeris file names
    end with _eph1.fits and are prefixed with the object name (for example
    commetXYZ or jupiter).  This will add additional object-centered 
    coordinate columns to the event file and aspect solution files.
  </PARA>
</ADESC>


<ADESC title="Changes in the scripts 4.14.0 (December 2021) release">
  <PARA>
    Updated the Level 2 event file keywords : CONTENT="EVT2"  and HDUCLAS2="ACCEPTED".
  </PARA>

</ADESC>



<ADESC title="Changes in the script 4.13.3 (September 2021) release">
  <PARA>
    The HRC-S/LETG bow-tie filter, designed to reduce background, 
    is not appropriate for data acquired after the HRC instrument
    gain was changed. The bow-tie filter is marked invalid in CALDB
    4.9.6 for these data.  chandra_repro has been modified to correctly
    recognize that the file is not appropriate and continue processing
    without it.  
  </PARA>

</ADESC>


<ADESC title="Changes in the scripts 4.13.1 (March 2021) release">
  <PARA>
    Now updates the reprocessed aspect solution file, pcadf*_repro_asol1.fits,
    to include the RA_NOM, DEC_NOM, and ROLL_NOM.  They keywords
    are removed the by asp_offaxis_corr tool but are required by
    MARX.
  </PARA>

    <PARA>
    The new parameter, pi_filter, controls whether the HRC-S+LETG
    background PI filter is applied or not, see
    <HREF link="https://cxc.cfa.harvard.edu/ciao/why/hrc_tgain.html">
    the HRC Why topic on gain</HREF> for details. The default is 'yes'
    to apply the filter.  Users should only set this parameter to 'no'
    if they have been instructed to do.
    </PARA>
</ADESC>


<ADESC title="Changes in the scripts 4.13.0 (December 2020) release">
  <PARA title="Update boresight correction in aspect solution files">
    If the script can only find original-format aspect solution files
    (those with CONTENT=ASPSOL) and with the new parameter 
    "asol_update=yes", then chandra_repro will run the new 
    asp_offaxis_corr tool to apply the DY,DZ, and DTHETA boresight 
    corrections directly to the RA, Dec, ROLL, and quaternion values.  
    This new aspect solution file will have CONTENT=ASPSOLOBI and should
    be used for all data analysis.
  </PARA>

  <PARA title="Other">
  Updates for tool changes in CIAO 4.13.  This includes changes in the hrc_process_events
  and tg_resolve_events parameter files (several defunct parameters
  have been removed).  HRC gratings datasets will also have additional
  columns including: AU|AV 1-3 and SUMAMPS.
  </PARA>

  <PARA>
    Update for HRS-S+LETG to use automatic CALDB lookup to locate 
    latest PI background filter file.    
  </PARA>

  <PARA>
    Update the recreate_tg_mask=yes option to use a clean event file 
    (GTI, status, and grade filtered) with tgdetect2.  The earlier
    behavior of using the Level 1 event file could lead to a poor 
    zeroth order location.  
  </PARA>

</ADESC>


<ADESC title="Changes in the scripts 4.12.2 (April 2020) release">
  <PARA title="Synchronization with DS 10.8.3 updates">
  In the spring of 2020, a new aspect solution file is being created. 
  This file has the DY, DZ, and DTHETA offsets folded back into the
  aspect solution itself (RA, Dec, Roll) and provides a better
  estimate of the off-axis angles.  It can be identified by the file
  name (a single file with OBS_ID and the OBI_NUM) and by the
  CONTENT keyword set to "ASPSOLOBI". The event processing tools
  like acis_process_events and hrc_process_events handle these 
  new aspect solution files transparently.  Users will notice 
  changes to their physical sky coordinates (x,y); however, 
  the final celestial coordinates (RA,Dec) are the same to within
  a fraction of pixel.
  </PARA>
  <PARA>
  While users should only have either the new CONTENT="ASPSOLOBI"
  or the CONTENT="ASPSOL" aspect solution files in their primary 
  directory; it is possible that they will have both.  chandra_repro
  now checks for this and will only use the CONTENT="ASPSOLOBI" file.
  </PARA>
  <PARA>
  As a result of this change, the new skyfov method=convexhull algorithm
  can now be used.  It provides a tighter bounding polygon around 
  each chip which will provide a better estimate of the geometric area.  
  </PARA>    
</ADESC>


<ADESC title="Changes in scripts 4.12.1 (December 2019) release">
  <PARA>
    Updated to support new badpixels associated with bottom rows
    of each CCD due to 'shadow' cast by frame-store cover.  
  </PARA>
</ADESC>


<ADESC title="Change in scripts 4.11.5 (October 2019) release">
  <PARA>
    Internal only changes to correct verbose handling in newer versions
    of Python.
  </PARA>
</ADESC>


<ADESC title="Changes in scripts 4.11.4 (August 2019) release">
 <PARA>
   Updated to support HRC observations with no Level 2 good time, ONTIME=0. 
   Users get a recalibrated Level 1 event file when they set cleanup=no.
 </PARA>

</ADESC>



<ADESC title="Changes in scripts 4.11.3 (May 2019) release">
  <PARA>
    chandra_repro now creates individual TYPE:I source and background 
    PHA files with the appropriate ANCRFILE, RESPFILE, BACKFILE,
    and BACKSCAL keywords set.
  </PARA>
  <PARA>
    For HRC-S+LETG datasets, the script now creates the grating
    responses for orders -8, -7, -6, -5, -4, -3, -2, -1, +1, +2, +3,
    +4, +5, +6, +7, and +8. Previously only the -1 and +1 orders were
    calculated.
  </PARA>
</ADESC>



<ADESC title="Changes in scripts 4.11.2 (April 2019) release">
  <PARA>
    Changes to allow observations where the Level 2 ONTIME
    is 0 to be fully processed. Previously the script would 
    error out when running the skyfov tool to create the FOV
    file.  It will now create the file but without using 
    a time filter.  
  </PARA>
</ADESC>


<ADESC title="Changes in scripts 4.11.1 (December 2018) release">
  <PARA>
    For HRC, the script will now retain all the columns defined
    in the hrc_process_events stdlev1 event definition parameter.
    This includes the coarse coordinates in addition to the new SAMP column.  
  </PARA>
</ADESC>



<ADESC title="Change in scripts 4.9.4 (July 2017) release">
  <PARA>
    Internal fix for uninitialized variable ("newasol") when processing
    an observation that does not have any aspect solution files.  This 
    is limited to observations of the Moon and the Earth.  These observations
    still cannot be processed at this time but the error message is more informative.
  </PARA>
</ADESC>



<ADESC title="Changes in scripts 4.9.2 (April 2017) release">
  <PARA>
    These are only internal changes to the script to tweak how HISTORY
    records are written and to correct some verbose output.
  </PARA>
</ADESC>


<ADESC title="Changes in scripts 4.8.4 (September 2016) release">
  <PARA>
    For ACIS CC mode data, pix_adj="default" now sets acis_process_events pix_adj=NONE 
    whereas before it would be set to "EDSER".
  </PARA>
</ADESC>

<ADESC title="Changes in scripts 4.7.2 (April 2015) release">
  <PARA>
    The following changes are included
  </PARA>
  <LIST>
    <ITEM>
    For consistency with the TGCat catalog, only the -1 and +1 order ARF and RMF are now
    created.  Users can run mktgresp to generate the response files for
    higher orders.
    </ITEM>
    <ITEM>Errors out if the absolute path name 
    for the input or output directories contains spaces.  </ITEM>
    <ITEM>Added support for FAINT_BIAS mode datasets (only a few very 
    early in the mission)</ITEM>
    <ITEM>Compares the files in the primary/ and secondary/ directory to
    the files listed in the event file header and issues a warning
    if they are different.</ITEM>
    <ITEM>Added a warning about using splitobs script for observations
    with multiple level 1 event files.
    </ITEM>
    <ITEM>
    ACIS TIME mode observations now have their GTIs aligned on
    exposure frame time boundaries using the new gti_align script.
    </ITEM>
    <ITEM>An additional time filter has been added that goes from the first aspect 
    record time to the last.  This is to address a rare condition where several
    of the first or last events in the level 2 event file are inside the 
    GTIs but occur outside the times covered by the aspect solution --
    which results in invalid sky coordinates during those times.
    </ITEM>
  </LIST>

</ADESC>


<ADESC title="Changes in scripts 4.7.1 (December 2014) release">
  <PARA>
    The default verbose level is now set to 1.  Also there are internal 
    changes to remove acis_process_events' calc_cc_times parameter.
    
  </PARA>

</ADESC>


<ADESC title="Changes in scripts 4.6.6 (September 2014) release">
  <PARA>
      The following changes were included
    </PARA>
    <LIST>
<ITEM>The script will now create a FOV file - which ends in
    _repro_fov1.fits - along with the other output products. This may
    be especially useful if the input data have been reprojected to a
    different tangent point or filtered exclude a different time range
    than that used in the archival processing.
</ITEM>
<ITEM>
   Added STATFILT keyword to event that gives the 32bit status that
    was used to create the level 2 event file.
</ITEM>

</LIST>

</ADESC>


<ADESC title="Changes in the scripts 4.6.1 (December 2013) release">
  <PARA>
      The following changes were included
    </PARA>
    <LIST>
<ITEM>The script now run r4_header_update to add the Repro-4 
header keywords if needed.
</ITEM>
<ITEM>
The centroid algorithm has been added as a pix_adj option.
</ITEM>
<ITEM>
The script now runs tgdetect2 for grating data when recreate_tg_mask=yes
</ITEM>
</LIST>  

</ADESC>

  
  <ADESC title="Change in the scripts 4.5.4 (August 2013) release">
    <PARA>
      The following changes were included
    </PARA>
    <LIST>
<ITEM>
    The pi=0:300 filter for HRC-S with no grating has been removed.  Users will
    not see any difference unless they have processed their data with
    CALDB 4.5.7.  The PI filter may optionally be used to reduce the background 
    noise for some observations.
</ITEM>
<ITEM>
    Bug fix when exactly 2 event files were present in the secondary 
    directory, but it was not an interleaved observation.
</ITEM>
<ITEM>
    Delay creation of output directory until the inputs have been verified.
</ITEM>
     
    </LIST>

  </ADESC>

  <ADESC title="Changes in the scripts 4.5.2 (April 2013) release">
    <PARA title="New recreate_tg_mask parameter">
        The recreate_tg_mask parameter is has been added to direct
        chandra_repro to use the existing REGION block attached the
        original evt2 file rather than re-run tgdetect2 and tg_create_mask.
        This is especially useful when the 0th order location was 
        manually adjusted in standard data processing.    
    </PARA>
    <PARA title="Grating response (ARF and RMF) files">
        chandra_repro will now create the appropriate ARF and RMF files
        for each order and grating arm that is in the _repro_pha2.fits file.
        It uses the default energy and channel grids.  These products are
        stored in a "tg" subdirectory.        
    </PARA>
    <PARA title="Interleaved mode">
        chandra_repro will now work on ACIS interleaved mode datasets without
        the user needing to split them into separate directories.  The 
        output products will have "e1" or "e2" in the file names that make
        the original primary and secondary exposures.    
    </PARA>
    <PARA title="Skip directories with missing level 1 event files">
        If chandra_repro encounters a directory where it cannot find
        the level1 data products it requires it will now skip that
        directory rather than exiting.    
    </PARA>


  </ADESC>


  <ADESC title="Changes in the October 2012 Release">
    <PARA title="Support for multiple observations">
        The indir parameter can now take a stack of directories 
	and the default outdir setting has changed to "".
    </PARA>
    <PARA title="Copying, rather than linking, files">
      The archive files - such as the aspect solution and
      mask files - are now copied rather than linked. This
      reverses the change made in the April 2012 release.
    </PARA>
  </ADESC>



    <ADESC title="Changes in the June 2012 Release">
    <LIST>
    <ITEM> The default for the check_vf_pha parameter has been changed from "yes" to "no".  It has been determined that this algorithm can remove good events for modestly bright point sources.</ITEM>

    <ITEM>In the event that a file systems does not support symbolic links (some external hard drives and thumb/USB drives), copies of the auxiliary files will be made.</ITEM>
    </LIST>
    </ADESC>

    <ADESC title="Changes in the April 2012 Release">
      <PARA title="Warning messages">
	Warnings produced by acis_process_events and hrc_process_events
	are now written out instead of being hidden (this happens
	even when verbose=0). Please see the Caveats section of the
	<HREF link="https://cxc.harvard.edu/ciao/bugs/acis_process_events.html">acis_process_events</HREF>
	and
	<HREF link="https://cxc.harvard.edu/ciao/bugs/hrc_process_events.html">hrc_process_events</HREF>
	bugs pages for information on whether these
	warnings can be safely ignored.
      </PARA>
      <PARA title="Links are now used when possible">
	The Archive data files necessary for data analysis are
	linked from the output directory instead of being copied. 
      </PARA>
    </ADESC>

    <ADESC title="Changes in the February 2012 Release">
      <LIST>
	<ITEM>
	  Improved error checking on the input directory.
	</ITEM>
      </LIST>
    </ADESC>

    <ADESC title="Changes in the December 2011 Release">
      <LIST>
	<ITEM>
	  The tools acis_find_afterglow (new in CIAO 4.4) and
	  acis_build_badpix are used in place of acis_run_hotpix
	  because acis_find_afterglow is more efficient at identifying
	  afterglows that have a small number (i.e. 4-10) of events. 
	</ITEM>

	<ITEM>
	  The status bits that are set by destreak or
	  acis_process_events are reset with the
	  acis_clear_status_bits script before the data are
	  reprocessed.  Previously, only the bits set by
	  acis_detect_afterglow were reset. 
	</ITEM>
	
	<ITEM>
	  The destreak tool is run before acis_find_afterglow to
	  improve the streak detection efficiency and to prevent
	  pixels with several streak events from being misidentified
	  as hot pixels. 
	</ITEM>

	<ITEM>
	  The default filename root is chosen from the first segment
	  of the level=1 event file, e.g. changed from
	  "acisf01838_000N002" to "acisf01838". 
	</ITEM>
      </LIST>
    </ADESC>

    <ADESC title="About Contributed Software">
      <PARA>
        This script is not an official part of the CIAO release but is
        made available as "contributed" software via the
        <HREF link="https://cxc.harvard.edu/ciao/download/scripts/">CIAO scripts page</HREF>.
        Please see this page for installation instructions.
      </PARA>
    </ADESC>


   <ADESC title="Caveats">
     <LIST>
       <ITEM>Large Datasets:  chandra_repro uncompresses files in memory before using them.
       This may consume too much memory on some machines and cause 
       chandra_repro to fail.  Since chandra_repro can work with files that
       have already been gunziped, the work around is to gunzip all
       the files before running this tool.
       </ITEM>
       <ITEM>Multi-obi datasets:  as noted above, multi-obi
       obsids need to be separated before running chandra_repro,
       which can be performed by the splitobs script.</ITEM>

     </LIST>
   </ADESC>


    <BUGS>
      <PARA>
        See the
        <HREF link="https://cxc.harvard.edu/ciao/bugs/chandra_repro.html">bugs page
        for this script</HREF> on the CIAO website for an up-to-date
        listing of known bugs.
      </PARA>
    </BUGS>

    <LASTMODIFIED>February 2025</LASTMODIFIED>
  </ENTRY>
</cxchelptopics>
