<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE cxchelptopics SYSTEM "CXCHelp.dtd" [
  <!ENTITY upr  "unix&#37;">
  <!ENTITY cltool "blanksky">
  <!ENTITY mdash "&#8212;">
]>

<cxchelptopics>
  <ENTRY key="&cltool;" context="Tools::Background"
	 refkeywords="background caldb &cltool;"
	 seealsogroups="bkgtools"
	 displayseealsogroups="">
    
    <SYNOPSIS>
      Tailor an unscaled blanksky background file to be compatible with a given
      events file; combining and reprojecting the necessary
      background files from the CalDB.  
    </SYNOPSIS>
    
    <DESC> 
      <PARA>
	This script will customize a blanksky background file for the
	input event file, using the instrument-specific background
	files in the CalDB.  By default, due to size, these background files are
	not included as part of the standard CalDB installation and must be
	specifically installed.
      </PARA>
      <PARA>
	The HRC-I background files are generated from exposures when
	the detector is active and not exposed to the telescope's
	optics, manifesting itself as a measure of the particle
	background.  Similar "stowed" particle background files exist for
	ACIS data.
      </PARA>
      <PARA>
	The ACIS blanksky background files used by this script are
	generated by co-adding sets of observations, taken over the
	course of the mission, of relatively empty fields, with the
	conditions of high galactic latitude (|b| &gt; 20 deg) and low,
	soft X-ray emission in the ROSAT All Sky Survey maps (sum of
	R4 + R5 bands &lt; 200).  All observations were performed using
	the entire CCD in standard timing mode with no gratings
	inserted.  
      </PARA>
      <PARA>
	The needed ACIS blanksky background files are selected for
	the observation and then processed as outlined in
	the <HREF link="https://cxc.harvard.edu/ciao/threads/acisbackground/#acisbg">"Analysing
	the ACIS Background with the 'Blank-Sky' Files"</HREF>
	analysis thread.  Multi-CCD observations will combine the
	background files for the corresponding CCDs <!--// and the gain
	corrections applied to the observation will then be applied to
	the co-added background file //--> before reprojecting the events to
	match the coordinates of the observation.   
      </PARA>
    </DESC>

    <QEXAMPLELIST>
      <QEXAMPLE>
        <SYNTAX>
          <LINE>&upr; &cltool; evtfile=evt.fits outfile=bkg_evt.fits</LINE>
        </SYNTAX>
        <DESC>
          <PARA>
	    For a given event file, "evt.fits", the appropriate
	    blanksky background files will be selected from the CalDB,
	    combined, and projected to the its matching coordinates as
	    "bkg_evt.fits".  The script will attempt to find the
	    required aspect solution file from the events file header.
          </PARA>
        </DESC>
      </QEXAMPLE>
      <QEXAMPLE>
        <SYNTAX>
          <LINE>&upr; &cltool; evtfile=evt.fits outfile=bkg_evt.fits asolfile=asol.fits</LINE>
        </SYNTAX>
        <DESC>
          <PARA>
	    The same as above, except the aspect solution file is explicitly specified.  
          </PARA>
        </DESC>
      </QEXAMPLE>
    </QEXAMPLELIST>

    <PARAMLIST>
      <PARAM name="evtfile" type="file" filetype="input" reqd="yes" stacks="no">
        <SYNOPSIS>
          Input event file.
        </SYNOPSIS>

        <DESC>
          <PARA>
	    An events file that the blanksky background will be tailored to match.
          </PARA>
        </DESC>
      </PARAM>

      <PARAM name="outfile" type="file" filetype="output" reqd="yes">
        <SYNOPSIS>
          Output file
        </SYNOPSIS>

        <DESC>
          <PARA>
            Output name of the events file-specific blanksky background file.
          </PARA>
        </DESC>
      </PARAM>

      <PARAM name="asolfile" type="file" filetype="input" reqd="yes" stacks="yes">
        <SYNOPSIS>
          Input aspect solutions.
        </SYNOPSIS>
        
        <DESC>
          <PARA>
            If the value is empty then the ASOLFILE keyword from the
            events file will be used to find the files to use.  An
            aspect solution is required for the script to run.
          </PARA>
          <PARA>
            The aspect solution files have names like
            pcadf*_asol1.fits and are included in the
            output directory of the chandra_repro script.
            To explicitly specify the asol files use
            the stack syntax (e.g. a comma, or space, separated
            string or an external file as described in
            <HREF link="https://cxc.harvard.edu/ciao/ahelp/stack.html">"ahelp
            stack"</HREF> for more information).
            So to use asol1.fits, asol2.fits, and asol3.fits you could say
            <EQUATION>asolfile="asol1.fits,asol2.fits,asol3.fits"</EQUATION>
            or
            <EQUATION>asolfile="asol1.fits asol2.fits asol3.fits"</EQUATION>
            or
            <EQUATION>asolfile=@asol.lis</EQUATION>
            where asol.lis contains the names of each file, one per line.
            The files do not have to be given in time order.
          </PARA>
          <PARA>
            Since there may be multiple asol files for an
            observation there may be more entries in this
            parameter than there are in the infiles parameter.
          </PARA>
          <PARA>
            Aspect histograms - the output of the asphist tool - can
            not be used here.
          </PARA>
        </DESC>
      </PARAM>

      <PARAM name="stowedbg" type="boolean" def="no" reqd="no">       
        <DESC>
          <PARA>
	    Query the set of stowed ACIS background.  Only available for CTI-corrected ACIS data.
          </PARA>
        </DESC>
      </PARAM>
      
      <PARAM name="weight_method" type="string" def="particle">
        <SYNOPSIS>
	  Method to calculate the background scaling factor.
        </SYNOPSIS>
        
        <DESC>
          <PARA>
	    This parameter determines the method used to calculate the
	    background scaling factor for a given observation.
          </PARA>
	  <PARA title="method=particle">
	    This option scales
	    the background by the ratio of the counts
	    in the range determined by the bkgparams
	    parameter, rather than by exposure
	    time.
	  </PARA>
	  <PARA title="method=time">
	    This setting scales the background file by the
	    ratio of the observation to background exposure
	    times. 
	  </PARA>
	  <PARA title="method=particle-rate">
	    This setting scales the background file by the
	    ratio of the observation to background high-energy
	    particle count rates. 
	  </PARA>
          <PARA title="Header keywords">
	    The scaling method and factor are added to the tailored
	    blanksky background file using the BKGMETH and BKGSCALE
	    keywords, respectively. 
	  </PARA>
        </DESC>
      </PARAM>

      <PARAM name="bkgparams" type="string" def="default">
        <SYNOPSIS>
	  Optional argument for calculating the particle background
	  scaling factor.  
        </SYNOPSIS>
        
        <DESC>
          <PARA>
	    This parameter is only used if "weight_method" is set to "particle" or "weight_method=particle-rate"
	    and otherwise ignored.  The default is [pi=300:500] for
	    HRC and [energy=9000:12000] for ACIS. 
          </PARA>
          <PARA>
	    The parameter is taken to be 
	    <HREF link="https://cxc.harvard.edu/ciao/ahelp/dmfiltering.html">a
	    Data Model filter</HREF>
	    to apply to both the observation and the 
	    particle background file, and is expected to
	    be of the form "[energy=lo:hi]" or "[pi=lo:hi]". It is used to select
	    a subset of the observation that represents
	    the particle background -- i.e. it is 
	    not strongly
	    "contaminated" by cosmic emission -- but
	    is close enough (in PI) to the source emission
	    to minimise differences in the spectral shape of
	    the particle emission between the observation and
	    that seen in the background observations or use the
	    high-energy event data (above 10 keV) to see how the
	    particle background normalization differs between your
	    observation and the background file. 
	  </PARA>
	</DESC>
      </PARAM>

      <PARAM name="tmpdir" type="string" def="${ASCDS_WORK_PATH}">
        <SYNOPSIS>
          Directory for temporary files. 
        </SYNOPSIS>
        <DESC>
          <PARA>
            Directory for storing temporary files that
            require further processing before becoming useful.
            If the directory does not exist then it will be created
            for use by the script, and then deleted.
          </PARA>
        </DESC>
      </PARAM>

      <PARAM name="random" type="integer" def="0" min="0">
        <SYNOPSIS>
	  Random seed for randomization.
        </SYNOPSIS>
        <DESC>
          <PARA>
	    The random parameter is sent to reproject_events when
	    processing the ACIS blanksky and HRC-I particle background
	    files to match the observation. A value of 0 uses the
	    system time to seed the random number generator. 
          </PARA>
        </DESC>
      </PARAM>    

      <PARAM name="clobber" type="boolean" def="no" reqd="no">
        <DESC>
          <PARA>
            Specifies if an existing output file should be
            overwritten.
          </PARA>
        </DESC>
      </PARAM>

      <PARAM name="verbose" type="integer" def="0">
        <SYNOPSIS> 
          Specifies the level of verbosity (0-5) in displaying
          diagnostic messages.
        </SYNOPSIS>
      </PARAM>
    </PARAMLIST>

    <ADESC title="Determining background scaling factor for an observation">
      <PARA>
	The background scaling method and factor are stored in the
	BKGMETH and BKGSCALE/BKGSCALn header keywords in the tailored blanksky
	background file, each BKGSCALn value corresponds to a specific
	chip.  These scaling values may be used to weight FITS image
	files, on a per chip basis, to be used with an observation. 
      </PARA>

      <PARA>
	When scaling by time, the ratio of the observation to blanksky
	files' LIVTIMEn keywords are calculated.  
      </PARA>

      <PARA>
	The basis for scaling by the high-energy particle background is described
	in <HREF link="https://ui.adsabs.harvard.edu/abs/2006ApJ...645...95H/abstract">"Absolute
	Measurement of the Unresolved Cosmic X-Ray Background in the
	0.5-8 keV Band with Chandra" (Hickox &amp; Markevitch, ApJ 645
	95)</HREF>.  The calculation of the factors are done by taking the
	ratio of the counts in the observation to the blanksky
	background for each chip in the energy band defined by the
	"bkgparams" parameter.  
      </PARA>
    </ADESC>    

    <ADESC title="Changes in the scripts 4.11.2 (April 2019) release">
      <PARA>
        The script no-longer copies over the RA_PNT, DEC_PNT, ROLL_PNT,
        DY_AVG, DZ_AVG, and DTH_AVG header keywords as they are now
        provided by reproject_events.
      </PARA>
    </ADESC>

    <ADESC title="Changes in the scripts 4.11.3 (May 2019) release">
      <PARA>
        The aimpoint chip is now calculated using the RA_PNT and DEC_PNT
        keywords, rather than the RA_NOM and DEC_NOM, to better support
        reprojected datasets.
      </PARA>
    </ADESC>

    <!-- I am guessing when this was added -->
    <ADESC title="Changes in the scripts 4.12.0 (December 2019) release">
      <PARA>
	The weight_method="particle-rate" scaling has been added which
	is calculated using the ratio of the observed high-energy
	event count rate, to the blanksky high-energy event count rate
	using the band defined by the "bkgparams" parameter.
	Additionally, support for VFAINT data where "check_vf_pha=no"
	is set in acis_process_events added.
      </PARA>
    </ADESC>

    <ADESC title="Changes in the scripts 4.15.0 (December 2022) release">
      <PARA>
	Querying the set of stowed ACIS background files has been
	added with the "stowedbg" parameter.  The stowed background
	(NXB) files will be used in lieu of blank sky background
	(CXB+NXB) files.  This feature only supports CTI-corrected ACIS
	data sets. 
      </PARA>
    </ADESC>

    <ADESC title="Changes in the scripts 4.15.1 (January 2023) release">
      <PARA>
	Corrected the screen output reporting the updated BKGSCAL
	keywords (the file output was correct).
      </PARA>
    </ADESC>

    <ADESC title="Changes in the November 2023 revision (scripts 4.16.0)">
      <PARA>
	Use the <tt>CHKVFPHA</tt> header keyword, introduced via <HREF
	link="https://cxc.harvard.edu/ciao/ahelp/acis_process_events.html">acis_process_events</HREF>
	in CIAO 4.16, to determine if VFAINT event status filtering
	should be applied, if available, but will fall back to the
	older determination technique if necessary.  Internal code
	clean up applied. 
      </PARA>
    </ADESC>
    
    <ADESC title="About Contributed Software">
      <PARA>
        This script is not an official part of the CIAO release but is
        made available as "contributed" software via the
        <HREF link="https://cxc.harvard.edu/ciao/download/scripts/">CIAO scripts page</HREF>.
        Please see this page for installation instructions - such as how to
        ensure that the parameter file is available.
      </PARA>
    </ADESC>

<!--//    
    <BUGS>
      <PARA>
        See the
        <HREF link="https://cxc.harvard.edu/ciao/bugs/&cltool;.html">bugs page
        for this script</HREF> on the CIAO website for an up-to-date
        listing of known bugs. 
      </PARA>
    </BUGS>
//-->    
    <LASTMODIFIED>November 2023</LASTMODIFIED>
  </ENTRY>
</cxchelptopics>
